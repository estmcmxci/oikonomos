# Ralph Loop State

## Task
OIK-52: Fix IntentRouter getNonce Revert in Trade Execution

## Context
Trade execution fails immediately after x402 payment verification with `getNonce` revert. The IntentRouter contract is deployed on Base Sepolia (chain ID 84532) but the treasury agent was hardcoding Ethereum Sepolia (chain ID 11155111).

**Branch:** `m/oik-52-fix-intentrouter-getnonce-revert-in-trade-execution`
**Linear:** OIK-52

## Root Cause
The `intentMode.ts` and other production files hardcoded `import { sepolia } from 'viem/chains'` which is Ethereum Sepolia (chain ID 11155111), while the contracts are deployed on Base Sepolia (chain ID 84532). This caused all RPC calls to go to the wrong network.

## Completed Tasks

### Task 1: Identify Root Cause ✅
- [x] Verified contract exists on Base Sepolia via `cast call`
- [x] `getNonce` works when called with correct chain
- [x] Found hardcoded `sepolia` imports across multiple files

### Task 2: Create Shared Chain Utility ✅
- [x] Created `agents/treasury-agent/src/config/chain.ts`
- [x] Exports `getChain(env)` function that returns correct chain based on CHAIN_ID
- [x] Supports both Sepolia (11155111) and Base Sepolia (84532)

### Task 3: Fix Production Files ✅
Updated to use `getChain(env)` instead of hardcoded `sepolia`:
- [x] `src/modes/intentMode.ts` - Core intent mode (getNonce, buildAndSignIntent, submitIntent)
- [x] `src/portfolio/handler.ts` - Portfolio handler
- [x] `src/quote/handler.ts` - Quote handler (on-chain quote)
- [x] `src/suggestion/handler.ts` - Suggest policy handler
- [x] `src/triggers/drift.ts` - Drift check trigger
- [x] `src/suggestion/marketplace.ts` - Marketplace ENS resolver

## Files Changed

| File | Change |
|------|--------|
| `src/config/chain.ts` | NEW - Shared chain utility |
| `src/modes/intentMode.ts` | Use `getChain(env)` |
| `src/portfolio/handler.ts` | Use `getChain(env)` |
| `src/quote/handler.ts` | Use `getChain(env)` |
| `src/suggestion/handler.ts` | Use `getChain(env)` |
| `src/triggers/drift.ts` | Use `getChain(env)` |
| `src/suggestion/marketplace.ts` | Use `getChain(env)` |

## Remaining Work

- [ ] Verify TypeScript compiles without errors
- [ ] Deploy updated treasury agent to Cloudflare Workers
- [ ] Run E2E test to verify getNonce works
- [ ] Test full trade execution flow

## Test Command

```bash
cd agents/treasury-agent
source ../../.env
PRIVATE_KEY="$DEPLOYER_PRIVATE_KEY" npx tsx scripts/x402-e2e-test.ts
```

## Status
Code changes complete. Pending verification and deployment.
