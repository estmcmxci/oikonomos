### Clone and Run x402 Mini App Example (Bash)

Source: https://docs.cdp.coinbase.com/x402/miniapps

This snippet outlines the steps to clone the x402 repository, navigate to the TypeScript miniapp example, install dependencies, build the project, and start the development server. It assumes Node.js 22+ and pnpm v10 are installed.

```bash
# Clone the x402 repository
git clone https://github.com/coinbase/x402.git
cd x402/examples/typescript

# Install dependencies and build packages
pnpm install && pnpm build

# Navigate to the miniapp example
cd fullstack/miniapp

# Copy environment variables
cp .env-local .env

# Configure your environment (see below)
# Then start the development server
pnpm dev
```

--------------------------------

### Running on Mainnet (Go Example)

Source: https://docs.cdp.coinbase.com/x402/quickstart-for-sellers

Configuration example for running your integration on Mainnet using the CDP facilitator with API keys in Go.

```APIDOC
## Mainnet Integration Setup (Go)

### Description
This example demonstrates how to configure the CDP facilitator client and payment middleware for Mainnet operation in a Go application.

### Method
N/A (Configuration Example)

### Endpoint
N/A (Configuration Example)

### Parameters
#### Path Parameters
N/A

#### Query Parameters
N/A

#### Request Body
N/A

### Request Example
```go
// Update network to mainnet
network := x402.Network("eip155:8453") // Base mainnet (CAIP-2)

// Create facilitator client for mainnet
facilitatorClient := x402http.NewHTTPFacilitatorClient(&x402http.FacilitatorConfig{
    URL: "https://api.cdp.coinbase.com/platform/v2/x402",
    // Add auth if required
})

r.Use(ginmw.X402Payment(ginmw.Config{
    Routes: x402http.RoutesConfig{
        "GET /weather": {
            Scheme:  "exact",
            PayTo:   payTo,
            Price:   "$0.001",
            Network: network,
        },
    },
    Facilitator: facilitatorClient,
    Schemes: []ginmw.SchemeConfig{
        {Network: network, Server: evm.NewExactEvmScheme()},
    },
}))
```

### Response
N/A (Configuration Example)

### Response Example
N/A (Configuration Example)
```

--------------------------------

### Running on Mainnet (Node.js Example)

Source: https://docs.cdp.coinbase.com/x402/quickstart-for-sellers

Configuration example for running your integration on Mainnet using the CDP facilitator with API keys in Node.js.

```APIDOC
## Mainnet Integration Setup (Node.js)

### Description
This example demonstrates how to configure the CDP facilitator client and the payment middleware for Mainnet operation in a Node.js application.

### Method
N/A (Configuration Example)

### Endpoint
N/A (Configuration Example)

### Parameters
#### Path Parameters
N/A

#### Query Parameters
N/A

#### Request Body
N/A

### Request Example
```typescript
import { paymentMiddleware, x402ResourceServer } from "@x402/express";
import { ExactEvmScheme } from "@x402/evm/exact/server";
import { HTTPFacilitatorClient } from "@x402/core/server";

// For mainnet, use CDP's facilitator with API keys
const facilitatorClient = new HTTPFacilitatorClient({
  url: "https://api.cdp.coinbase.com/platform/v2/x402",
  // Add auth headers if required
});

const server = new x402ResourceServer(facilitatorClient)
  .register("eip155:8453", new ExactEvmScheme()); // Base mainnet

app.use(
  paymentMiddleware(
    {
      "GET /weather": {
        accepts: [
          {
            scheme: "exact",
            price: "$0.001",
            network: "eip155:8453", // Base mainnet (CAIP-2)
            payTo: "0xYourAddress",
          },
        ],
        description: "Weather data",
        mimeType: "application/json",
      },
    },
    server,
  ),
);
```

### Response
N/A (Configuration Example)

### Response Example
N/A (Configuration Example)
```

--------------------------------

### Install and Build x402 Example Project

Source: https://docs.cdp.coinbase.com/x402/mcp-server

This bash script clones the x402 repository, navigates to the TypeScript examples, installs dependencies using pnpm, builds the packages, and then changes the directory to the MCP client example. It assumes Node.js v20+ and pnpm v10 are installed.

```bash
git clone https://github.com/coinbase/x402.git
cd x402/examples/typescript

pnpm install && pnpm build

cd clients/mcp
```

--------------------------------

### Migrate Buyer Fetch Client from v1 to v2

Source: https://docs.cdp.coinbase.com/x402/migration-guide

This example shows the migration of a buyer-side fetch client from v1 to v2. It includes updates to the client setup, scheme registration, and response handling.

```typescript
import { wrapFetchWithPayment, decodeXPaymentResponse } from "x402-fetch";

const fetchWithPayment = wrapFetchWithPayment(fetch, account);
const response = await fetchWithPayment(url);
const paymentResponse = decodeXPaymentResponse(response);
```

```typescript
import { x402Client, wrapFetchWithPayment, x402HTTPClient } from "@x402/fetch";
import { registerExactEvmScheme } from "@x402/evm/exact/client";
import { privateKeyToAccount } from "viem/accounts";

const signer = privateKeyToAccount(privateKey);

const client = new x402Client();
registerExactEvmScheme(client, { signer });

const fetchWithPayment = wrapFetchWithPayment(fetch, client);
const response = await fetchWithPayment(url);

// Get payment receipt
const httpClient = new x402HTTPClient(client);
const paymentResponse = httpClient.getPaymentSettleResponse(
  (name) => response.headers.get(name)
);
```

--------------------------------

### Install Node.js x402 Dependencies (Next.js)

Source: https://docs.cdp.coinbase.com/x402/quickstart-for-sellers

Installs the required x402 packages for integration with a Next.js application. This covers the Next.js middleware, EVM mechanism, and core x402 features.

```bash
npm install @x402/next @x402/evm @x402/core
```

--------------------------------

### Go Gin Server with X402 Payment Middleware

Source: https://docs.cdp.coinbase.com/x402/quickstart-for-sellers

This Go example sets up a Gin web server with the x402 payment middleware applied to specific routes. It configures payment schemes, facilitators, and route-specific pricing and network details.

```go
package main

import (
	"net/http"
	"time"

	x402 "github.com/coinbase/x402/go"
	x402http "github.com/coinbase/x402/go/http"
	ginmw "github.com/coinbase/x402/go/http/gin"
	evf "github.com/coinbase/x402/go/mechanisms/evm/exact/server"
	"github.com/gin-gonic/gin"
)

func main() {
	payTo := "0xYourAddress"
	network := x402.Network("eip155:84532") // Base Sepolia (CAIP-2 format)

	r := gin.Default()

	// Create facilitator client
	facilitatorClient := x402http.NewHTTPFacilitatorClient(&x402http.FacilitatorConfig{
		URL: "https://x402.org/facilitator",
	})

	// Apply x402 payment middleware
	r.Use(ginmw.X402Payment(ginmw.Config{
		Routes: x402http.RoutesConfig{
			"GET /weather": {
				Scheme:      "exact",
				PayTo:       payTo,
				Price:       "$0.001",
				Network:     network,
				Description: "Get weather data for a city",
				MimeType:    "application/json",
			},
		},
		Facilitator: facilitatorClient,
		Schemes: []ginmw.SchemeConfig{
			{Network: network, Server: evf.NewExactEvmScheme()},
		},
		Initialize: true,
		Timeout:    30 * time.Second,
	}))

	// Protected endpoint
	r.GET("/weather", func(c *gin.Context) {
		c.JSON(http.StatusOK, gin.H{
			"weather":     "sunny",
			"temperature": 70,
		})
	})

	r.Run(":4021")
}

```

--------------------------------

### Install Node.js x402 Dependencies (Hono)

Source: https://docs.cdp.coinbase.com/x402/quickstart-for-sellers

Installs the x402 packages needed for integration with a Hono.js server. This includes the Hono middleware, EVM mechanism, and core components.

```bash
npm install @x402/hono @x402/evm @x402/core
```

--------------------------------

### Install Node.js x402 Dependencies (Express)

Source: https://docs.cdp.coinbase.com/x402/quickstart-for-sellers

Installs the necessary x402 packages for integrating with an Express.js server. This includes the Express middleware, EVM mechanism, and core functionalities.

```bash
npm install @x402/express @x402/evm @x402/core
```

--------------------------------

### Node.js Server Setup with Protected Route

Source: https://docs.cdp.coinbase.com/x402/quickstart-for-sellers

This snippet demonstrates setting up a basic HTTP server using Express.js and defining a protected route that requires payment. It leverages the `x402` library for handling payment requirements.

```typescript
import express from "express";
import {
  serve,
  Facilitator,
  FacilitatorConfig,
  RoutesConfig,
  SchemeConfig,
} from "@coinbase/x402";

const app = express();

// Placeholder for facilitator and server setup
const facilitator: Facilitator = {
  // ... facilitator implementation details
};

const routes: RoutesConfig = {
  // ... route configuration details
};

const schemes: SchemeConfig[] = [
  // ... scheme configuration details
];

// Assume 'server' is initialized elsewhere, possibly with x402 middleware
// For demonstration, we'll directly use the app.get for the protected route.

app.get("/protected-route", (c) => {
  return c.json({ message: "This content is behind a paywall" });
});

// Assuming 'serve' is a function that starts the server
// The actual implementation might differ based on the x402 library usage.
serve({
  fetch: app.fetch, // This might need adjustment based on the actual 'app' object type
  port: 3000,
});

```

--------------------------------

### Configure CDP Facilitator for Mainnet Payments (Go)

Source: https://docs.cdp.coinbase.com/x402/quickstart-for-sellers

This Go code snippet demonstrates setting up the CDP facilitator for mainnet payments. It defines the mainnet network, creates an HTTPFacilitatorClient pointing to the mainnet API, and configures the Gin middleware for x402 payments. Ensure you have the necessary 'x402' and 'x402http' packages installed.

```go
// Update network to mainnet
network := x402.Network("eip155:8453") // Base mainnet (CAIP-2)

// Create facilitator client for mainnet
facilitatorClient := x402http.NewHTTPFacilitatorClient(&x402http.FacilitatorConfig{
    URL: "https://api.cdp.coinbase.com/platform/v2/x402",
    // Add auth if required
})

r.Use(ginmw.X402Payment(ginmw.Config{
    Routes: x402http.RoutesConfig{
        "GET /weather": {
            Scheme:  "exact",
            PayTo:   payTo,
            Price:   "$0.001",
            Network: network,
        },
    },
    Facilitator: facilitatorClient,
    Schemes: []ginmw.SchemeConfig{
        {Network: network, Server: evm.NewExactEvmScheme()},
    },
}))
```

--------------------------------

### Migrate Buyer Axios Client from v1 to v2

Source: https://docs.cdp.coinbase.com/x402/migration-guide

This example demonstrates the migration of a buyer-side Axios client from v1 to v2, including updates to client initialization and payment interceptor setup.

```typescript
import { withPaymentInterceptor } from "x402-axios";

const client = withPaymentInterceptor(axios.create({ baseURL }), account);
```

```typescript
import { x402Client, withPaymentInterceptor } from "@x402/axios";
import { registerExactEvmScheme } from "@x402/evm/exact/client";
import { privateKeyToAccount } from "viem/accounts";

const signer = privateKeyToAccount(privateKey);

const x402client = new x402Client();
registerExactEvmScheme(x402client, { signer });

const client = withPaymentInterceptor(axios.create({ baseURL }), x402client);
```

--------------------------------

### Install x402 Node.js Dependencies

Source: https://docs.cdp.coinbase.com/x402/quickstart-for-buyers

Installs the necessary x402 client packages for Node.js, including support for fetch, Axios, EVM, and Solana. It also includes optional packages for Bazaar discovery.

```bash
# For fetch-based clients
npm install @x402/fetch @x402/evm

# For axios-based clients
npm install @x402/axios @x402/evm

# For Solana support, also add:
npm install @x402/svm

# For Bazaar discovery (optional):
npm install @x402/core @x402/extensions
```

--------------------------------

### Install x402 v2 Packages for Buyers (Client-Side)

Source: https://docs.cdp.coinbase.com/x402/migration-guide

Instructions for installing the necessary v2 packages for client-side integrations using npm. This involves uninstalling v1 packages and installing new modular packages for Fetch and Axios, with optional EVM or SVM support.

```bash
# Fetch
npm uninstall x402-fetch
npm install @x402/fetch

# Axios
npm uninstall x402-axios
npm install @x402/axios

# For EVM (Ethereum) support, add:
npm install @x402/evm

# For SVM (Solana) support, add:
npm install @x402/svm
```

--------------------------------

### Install x402 v2 Packages for Sellers (Server-Side)

Source: https://docs.cdp.coinbase.com/x402/migration-guide

Instructions for installing the necessary v2 packages for server-side integrations using npm. This includes uninstalling v1 packages and installing new modular packages for frameworks like Express, Next.js, and Hono, along with optional EVM or SVM support.

```bash
# Express
npm uninstall x402-express
npm install @x402/express @coinbase/x402@^2.0.0

# Next.js
npm uninstall x402-next
npm install @x402/next @coinbase/x402@^2.0.0

# Hono
npm uninstall x402-hono
npm install @x402/hono @coinbase/x402@^2.0.0

# For EVM (Ethereum) support, add:
npm install @x402/evm

# For SVM (Solana) support, add:
npm install @x402/svm
```

--------------------------------

### Install x402 Go Module

Source: https://docs.cdp.coinbase.com/x402/support/github

This command fetches the x402 Go module using the `go get` utility. This is the standard procedure for Go developers to incorporate the x402 library into their Go projects, enabling them to build applications that utilize the x402 payment protocol.

```bash
go get github.com/coinbase/x402/go
```

--------------------------------

### Server-Side Configuration with Go

Source: https://docs.cdp.coinbase.com/x402/network-support

Example of server-side payment configuration using Go with the x402 library. It shows how to set up a payment route for a specific network (Base Sepolia) and facilitator.

```go
import (
    x402 "github.com/coinbase/x402/go"
    x402http "github.com/coinbase/x402/go/http"
    evm "github.com/coinbase/x402/go/mechanisms/evm/exact/server"
)

network := x402.Network("eip155:84532") // Base Sepolia

r.Use(ginmw.X402Payment(ginmw.Config{
    Routes: x402http.RoutesConfig{
        "GET /api": {
            Scheme:  "exact",
            PayTo:   payTo,
            Price:   "$0.001",
            Network: network,
        },
    },
    Facilitator: facilitatorClient,
    Schemes: []ginmw.SchemeConfig{
        {Network: network, Server: evm.NewExactEvmScheme()},
    },
}))
```

--------------------------------

### Install x402 SDKs for TypeScript Projects

Source: https://docs.cdp.coinbase.com/x402/support/github

This section provides installation instructions for various x402 SDKs using npm for TypeScript projects. It lists commands for installing comprehensive SDK packages or minimal client implementations focused on Fetch or Express.js servers. These packages are essential for integrating x402 functionality into your TypeScript applications.

```bash
# All available reference sdks
npm install @x402/core @x402/evm @x402/svm @x402/axios @x402/fetch @x402/express @x402/hono @x402/next @x402/paywall @x402/extensions

# Minimal Fetch client
npm install @x402/core @x402/evm @x402/svm @x402/fetch

# Minimal express Server
npm install @x402/core @x402/evm @x402/svm @x402/express
```

--------------------------------

### Add Payment Middleware to Node.js Hono App

Source: https://docs.cdp.coinbase.com/x402/quickstart-for-sellers

This example illustrates integrating payment middleware into a Node.js Hono application using the `@x402/hono` package. It sets up a protected route '/protected-route' with a payment condition defined by the 'exact' EVM scheme. The `paymentMiddleware` function from the library is used to enforce the payment requirement.

```typescript
import { Hono } from "hono";
import { serve } from "@hono/node-server";
import { paymentMiddleware, x402ResourceServer } from "@x402/hono";
import { ExactEvmScheme } from "@x402/evm/exact/server";
import { HTTPFacilitatorClient } from "@x402/core/server";

const app = new Hono();
const payTo = "0xYourAddress";

const facilitatorClient = new HTTPFacilitatorClient({
  url: "https://x402.org/facilitator"
});

const server = new x402ResourceServer(facilitatorClient)
  .register("eip155:84532", new ExactEvmScheme());

app.use(
  paymentMiddleware(
    {
      "/protected-route": {
        accepts: [
          {
            scheme: "exact",
            price: "$0.10",
            network: "eip155:84532",
            payTo,
          },
        ],
        description: "Access to premium content",
        mimeType: "application/json",
      },

```

--------------------------------

### Migrate Next.js Middleware from v1 to v2

Source: https://docs.cdp.coinbase.com/x402/migration-guide

This example demonstrates the migration of Next.js middleware for payment processing from v1 to v2, highlighting the shift to `paymentProxy` and updated server configuration.

```typescript
import { paymentMiddleware } from "x402-next";
import { facilitator } from "@coinbase/x402";

export const middleware = paymentMiddleware(
  "0xYourAddress",
  { "/api/protected": { price: "$0.01", network: "base" } },
  facilitator,
);
```

```typescript
import { paymentProxy, x402ResourceServer } from "@x402/next";
import { ExactEvmScheme } from "@x402/evm/exact/server";
import { HTTPFacilitatorClient } from "@x402/core/server";

const facilitatorClient = new HTTPFacilitatorClient({
  url: "https://x402.org/facilitator"
});

const server = new x402ResourceServer(facilitatorClient)
  .register("eip155:8453", new ExactEvmScheme());

export const middleware = paymentProxy(
  {
    "/api/protected": {
      accepts: [
        {
          scheme: "exact",
          price: "$0.01",
          network: "eip155:8453",
          payTo: "0xYourAddress",
        },
      ],
      description: "Protected endpoint",
    },
  },
  server,
);
```

--------------------------------

### Enhance Discovery with Metadata

Source: https://docs.cdp.coinbase.com/x402/quickstart-for-sellers

Enable your endpoints to be listed in the x402 Bazaar for better discoverability by buyers and AI agents by including descriptive metadata in your route configuration.

```APIDOC
## GET /weather

### Description
Get real-time weather data including temperature, conditions, and humidity.

### Method
GET

### Endpoint
/weather

### Parameters
#### Query Parameters
N/A

#### Request Body
N/A

### Request Example
N/A

### Response
#### Success Response (200)
- **(object)** - Weather data object
  - **temperature** (number) - Current temperature
  - **conditions** (string) - Current weather conditions
  - **humidity** (number) - Current humidity percentage

#### Response Example
```json
{
  "temperature": 22,
  "conditions": "Sunny",
  "humidity": 60
}
```

### Metadata for Bazaar Discovery
- **description**: "Get real-time weather data including temperature, conditions, and humidity"
- **mimeType**: "application/json"
- **extensions.bazaar**: `{
    "discoverable": true,
    "category": "weather",
    "tags": ["forecast", "real-time"]
  }`
```

--------------------------------

### Start x402 Express Server

Source: https://docs.cdp.coinbase.com/x402/mcp-server

This bash command navigates to the express server directory within the x402 examples and starts the server using pnpm. This server should be running at the URL specified in the `RESOURCE_SERVER_URL` environment variable during Claude Desktop configuration.

```bash
cd servers/express
pnpm dev
```

--------------------------------

### Instantiate CDP Client for EVM in Node.js

Source: https://docs.cdp.coinbase.com/x402/quickstart-for-buyers

Sets up the CDP client and creates an EVM account using the CDP SDK and viem in a Node.js environment. Requires API keys and wallet secrets from environment variables.

```typescript
import { CdpClient } from "@coinbase/cdp-sdk";
import { toAccount } from "viem/accounts";
import dotenv from "dotenv";

dotenv.config();

const cdp = new CdpClient();
const cdpAccount = await cdp.evm.createAccount();
const signer = toAccount(cdpAccount);
```

--------------------------------

### TypeScript: Multi-Network Client Setup with x402

Source: https://docs.cdp.coinbase.com/x402/quickstart-for-buyers

Sets up an x402 client capable of handling multiple payment schemes (EVM and Solana) by registering specific scheme handlers. It uses private keys for signing transactions on different networks and wraps the native fetch API for automatic payment processing.

```typescript
import { x402Client, wrapFetchWithPayment } from "@x402/fetch";
import { registerExactEvmScheme } from "@x402/evm/exact/client";
import { registerExactSvmScheme } from "@x402/svm/exact/client";
import { privateKeyToAccount } from "viem/accounts";
import { createKeyPairSignerFromBytes } from "@solana/kit";
import { base58 } from "@scure/base";

// Create signers
const evmSigner = privateKeyToAccount(
  process.env.EVM_PRIVATE_KEY as `0x${string}`,
);
const svmSigner = await createKeyPairSignerFromBytes(
  base58.decode(process.env.SOLANA_PRIVATE_KEY!),
);

// Create client with multiple schemes
const client = new x402Client();
registerExactEvmScheme(client, { signer: evmSigner });
registerExactSvmScheme(client, { signer: svmSigner });

const fetchWithPayment = wrapFetchWithPayment(fetch, client);

// Now handles both EVM and Solana networks automatically!
```

--------------------------------

### TypeScript: x402 Error Handling Example

Source: https://docs.cdp.coinbase.com/x402/quickstart-for-buyers

Demonstrates robust error handling for x402 payment requests using a try-catch block. It specifically checks for common error messages like "No scheme registered" and "Payment already attempted" to provide user-friendly feedback.

```typescript
try {
  const response = await fetchWithPayment(url, { method: "GET" });
  // Handle success
} catch (error) {
  if (error.message.includes("No scheme registered")) {
    console.error("Network not supported - register the appropriate scheme");
  } else if (error.message.includes("Payment already attempted")) {
    console.error("Payment failed on retry");
  } else {
    console.error("Request failed:", error);
  }
}
```

--------------------------------

### Configure CDP Facilitator for Mainnet Payments (Node.js)

Source: https://docs.cdp.coinbase.com/x402/quickstart-for-sellers

This Node.js code configures the CDP facilitator for mainnet payments using API keys. It initializes an HTTPFacilitatorClient with the mainnet API URL and registers the payment middleware with route configurations including pricing, network, and description. Ensure you have the necessary '@x402/express' and '@x402/core' packages installed.

```typescript
import { paymentMiddleware, x402ResourceServer } from "@x402/express";
import { ExactEvmScheme } from "@x402/evm/exact/server";
import { HTTPFacilitatorClient } from "@x402/core/server";

// For mainnet, use CDP's facilitator with API keys
const facilitatorClient = new HTTPFacilitatorClient({
  url: "https://api.cdp.coinbase.com/platform/v2/x402",
  // Add auth headers if required
});

const server = new x402ResourceServer(facilitatorClient)
  .register("eip155:8453", new ExactEvmScheme()); // Base mainnet

app.use(
  paymentMiddleware(
    {
      "GET /weather": {
        accepts: [
          {
            scheme: "exact",
            price: "$0.001",
            network: "eip155:8453", // Base mainnet (CAIP-2)
            payTo: "0xYourAddress",
          },
        ],
        description: "Weather data",
        mimeType: "application/json",
      },
    },
    server,
  ),
);
```

--------------------------------

### Migrate Express Middleware from v1 to v2

Source: https://docs.cdp.coinbase.com/x402/migration-guide

This example illustrates the migration of Express middleware for payment processing from v1 to v2. It shows the changes in function signatures and configuration structure.

```typescript
import { paymentMiddleware, Network } from "x402-express";
import { facilitator } from "@coinbase/x402";

app.use(paymentMiddleware(
  "0xYourAddress",
  {
    "GET /weather": {
      price: "$0.001",
      network: "base-sepolia",
      config: { description: "Weather data" }
    },
  },
  { url: "https://x402.org/facilitator" }
));
```

```typescript
import { paymentMiddleware, x402ResourceServer } from "@x402/express";
import { ExactEvmScheme } from "@x402/evm/exact/server";
import { HTTPFacilitatorClient } from "@x402/core/server";

const facilitatorClient = new HTTPFacilitatorClient({
  url: "https://x402.org/facilitator"
});

const server = new x402ResourceServer(facilitatorClient)
  .register("eip155:84532", new ExactEvmScheme());

app.use(
  paymentMiddleware(
    {
      "GET /weather": {
        accepts: [
          {
            scheme: "exact",
            price: "$0.001",
            network: "eip155:84532",
            payTo: "0xYourAddress",
          },
        ],
        description: "Weather data",
        mimeType: "application/json",
      },
    },
    server,
  ),
);
```

--------------------------------

### Go: Fetch Available Services from x402 Discovery

Source: https://docs.cdp.coinbase.com/x402/quickstart-for-buyers

Fetches a list of available services from the x402 discovery endpoint using a simple HTTP GET request. It then decodes the JSON response into a Go struct containing the service items and prints the total count of discovered services.

```go
import (
    "encoding/json"
    "fmt"
    "net/http"
)

// Fetch available services
resp, _ := http.Get("https://api.cdp.coinbase.com/platform/v2/x402/discovery/resources")
def resp.Body.Close()

var services struct {
    Items []map[string]interface{} `json:"items"`
}
json.NewDecoder(resp.Body).Decode(&services)

fmt.Printf("Found %d services\n", len(services.Items))
```

--------------------------------

### Install Bazaar Extension Package (Go)

Source: https://docs.cdp.coinbase.com/x402/bazaar

Installs the Bazaar extension package for Go, allowing Go developers to integrate with the x402 Bazaar for API discoverability. This step is necessary for registering the Bazaar extension on resource servers.

```bash
go get github.com/coinbase/x402/go/extensions/bazaar
```

--------------------------------

### Install x402 Python Package

Source: https://docs.cdp.coinbase.com/x402/support/github

This command installs the x402 Python package using pip. This is the recommended method for Python developers to integrate x402 payment capabilities into their projects. Ensure you have pip installed and configured correctly before running this command.

```bash
pip install x402
```

--------------------------------

### Create EVM Signer from Private Key in Node.js

Source: https://docs.cdp.coinbase.com/x402/quickstart-for-buyers

Initializes an EVM signer using a private key stored in an environment variable, leveraging the viem library for Node.js.

```typescript
import { privateKeyToAccount } from "viem/accounts";

// Create a signer from private key (use environment variable)
const signer = privateKeyToAccount(
  process.env.EVM_PRIVATE_KEY as `0x${string}`,
);
```

--------------------------------

### TypeScript: Discover Services with x402 Bazaar

Source: https://docs.cdp.coinbase.com/x402/quickstart-for-buyers

Dynamically discovers available services using the x402 Bazaar. It queries for HTTP resources, filters them based on affordability (cost under $0.10), and logs the results. This enables building autonomous agents that can find and utilize new capabilities.

```typescript
import { HTTPFacilitatorClient } from "@x402/core/http";
import { withBazaar } from "@x402/extensions/bazaar";

// Create facilitator client with Bazaar extension
const facilitatorClient = withBazaar(
  new HTTPFacilitatorClient({
    url: "https://api.cdp.coinbase.com/platform/v2/x402"
  })
);

// Query available services
const discovery = await facilitatorClient.extensions.discovery.listResources({
  type: "http",
  limit: 20,
});

// Filter services by criteria
const affordableServices = discovery.items.filter((item) =>
  item.accepts.some((req) => Number(req.amount) < 100000) // Under $0.10
);

console.log("Available services:", affordableServices);
```

--------------------------------

### x402 Mini App Environment Configuration (.env)

Source: https://docs.cdp.coinbase.com/x402/miniapps

This is an example `.env` file for configuring the x402 Mini App. It includes required settings for x402 payments, optional OnchainKit configuration, and app URLs/images. Ensure sensitive information like API keys and wallet addresses are handled securely.

```env
# x402 Payment Configuration (required)
FACILITATOR_URL=https://x402.org/facilitator
EVM_ADDRESS=0xYourWalletAddress

# OnchainKit Configuration
NEXT_PUBLIC_ONCHAINKIT_API_KEY=your_onchainkit_api_key_here
NEXT_PUBLIC_ONCHAINKIT_PROJECT_NAME=x402 Mini App

# App URLs and Images
NEXT_PUBLIC_URL=http://localhost:3000
NEXT_PUBLIC_APP_HERO_IMAGE=https://example.com/app-logo.png
NEXT_PUBLIC_SPLASH_IMAGE=https://example.com/app-logo-200x200.png
NEXT_PUBLIC_SPLASH_BACKGROUND_COLOR=#3b82f6
NEXT_PUBLIC_ICON_URL=https://example.com/app-logo.png
```

--------------------------------

### Install Dependencies for CDP Coinbase x402 (Node.js)

Source: https://docs.cdp.coinbase.com/x402/bazaar

Installs the necessary core, extensions, fetch, and EVM packages for the CDP Coinbase x402 project using npm. This command is used for Node.js environments.

```bash
npm install @x402/core @x402/extensions @x402/fetch @x402/evm
```

--------------------------------

### Node.js: Automatically Handle 402 Payments with @x402/fetch

Source: https://docs.cdp.coinbase.com/x402/quickstart-for-buyers

The @x402/fetch package extends the native `fetch` API to automatically handle 402 Payment Required responses. It verifies payments, generates `PAYMENT-SIGNATURE` headers, and retries requests with proof of payment. Dependencies include `@x402/fetch`, `@x402/evm/exact/client`, and `viem`. It takes a URL and fetch options as input and returns a response object with payment settlement details in the headers.

```typescript
import { x402Client, wrapFetchWithPayment, x402HTTPClient } from "@x402/fetch";
import { registerExactEvmScheme } from "@x402/evm/exact/client";
import { privateKeyToAccount } from "viem/accounts";

// Create signer
const signer = privateKeyToAccount(process.env.EVM_PRIVATE_KEY as `0x${string}`);

// Create x402 client and register schemes
const client = new x402Client();
registerExactEvmScheme(client, { signer });

// Wrap fetch with payment handling
const fetchWithPayment = wrapFetchWithPayment(fetch, client);

// Make request - payment is handled automatically
const response = await fetchWithPayment("https://api.example.com/paid-endpoint", {
  method: "GET",
});

const body = await response.json();
console.log("Response:", body);

// Get payment receipt from response headers
if (response.ok) {
  const httpClient = new x402HTTPClient(client);
  const paymentResponse = httpClient.getPaymentSettleResponse(
    (name) => response.headers.get(name)
  );
  console.log("Payment settled:", paymentResponse);
}
```

--------------------------------

### Go: Automatically Handle 402 Payments with x402/go

Source: https://docs.cdp.coinbase.com/x402/quickstart-for-buyers

The `x402/go` package provides a way to automatically handle 402 Payment Required responses for Go HTTP clients. It wraps the standard `net/http` client to manage payment flows and retries. Key dependencies include `x402/go` and its EVM mechanism. The function takes an HTTP request and returns an HTTP response, with payment settlement details potentially available in the headers.

```go
package main

import (
	"context"
	"encoding/json"
	"fmt"
	"net/http"
	"os"
	"time"

	x402 "github.com/coinbase/x402/go"
	evm "github.com/coinbase/x402/go/mechanisms/evm/exact/client"
)

func main() {
	privateKey := os.Getenv("EVM_PRIVATE_KEY")
	url := "http://localhost:4021/weather"

	// Create x402 client and register EVM scheme
	client := x402.NewX402Client()
	evm.RegisterExactEvmScheme(client, &evm.Config{
		PrivateKey: privateKey,
	})

	// Wrap HTTP client with payment handling
	httpClient := x402.WrapHTTPClient(client)

	// Make request - payment is handled automatically
	ctx, cancel := context.WithTimeout(context.Background(), 30*time.Second)
	defer cancel()

	req, _ := http.NewRequestWithContext(ctx, "GET", url, nil)
	resp, err := httpClient.Do(req)
	if err != nil {
		fmt.Printf("Request failed: %v\n", err)
		return
	}
	defer resp.Body.Close()

	// Read response
	var data map[string]interface{}
```

--------------------------------

### Install Bazaar Extension Package (Node.js)

Source: https://docs.cdp.coinbase.com/x402/bazaar

Installs the @x402/extensions package for Node.js, which includes the Bazaar extension for making API endpoints discoverable. This is a prerequisite for sellers to register the Bazaar extension on their resource server.

```bash
npm install @x402/extensions
```

--------------------------------

### Configure Multi-Network Support (CAIP-2)

Source: https://docs.cdp.coinbase.com/x402/quickstart-for-sellers

This snippet illustrates how to configure the CDP facilitator to support multiple networks (e.g., Base and Solana) on a single endpoint. It defines payment options for each supported network.

```typescript
    // Support multiple networks on the same endpoint
    {
      "GET /weather": {
        accepts: [
          {
            scheme: "exact",
            price: "$0.001",
            network: "eip155:8453",
            payTo: "0xYourEvmAddress",
          },
          {
            scheme: "exact",
            price: "$0.001",
            network: "solana:5eykt4UsFv8P8NJdTREpY1vzqKqZKvdp",
            payTo: "YourSolanaAddress",
          },
        ],
        description: "Weather data",
      },
    }
```

--------------------------------

### Load EVM Private Key in Go

Source: https://docs.cdp.coinbase.com/x402/quickstart-for-buyers

Loads an EVM private key from an environment variable using Go's crypto libraries for use with the Ethereum ecosystem.

```go
import (
    "crypto/ecdsa"
    "github.com/ethereum/go-ethereum/crypto"
)

// Load private key from environment
privateKey, _ := crypto.HexToECDSA(os.Getenv("EVM_PRIVATE_KEY"))
```

--------------------------------

### Environment Variables for Mainnet API Keys (Bash)

Source: https://docs.cdp.coinbase.com/x402/quickstart-for-sellers

This bash snippet shows the environment variables required to authenticate with the CDP mainnet facilitator. You need to set `CDP_API_KEY_ID` and `CDP_API_KEY_SECRET` with your generated API credentials from the Coinbase Developer Platform.

```bash
CDP_API_KEY_ID=your-api-key-id
CDP_API_KEY_SECRET=your-api-key-secret
```

--------------------------------

### X402 Route Configuration Interface

Source: https://docs.cdp.coinbase.com/x402/quickstart-for-sellers

Defines the TypeScript interface for configuring routes that require payment via the X402 protocol. It specifies payment schemes, pricing, network details, and optional metadata.

```typescript
interface RouteConfig {
  accepts: Array<{
    scheme: string;           // Payment scheme (e.g., "exact")
    price: string;            // Price in dollars (e.g., "$0.01")
    network: string;          // Network in CAIP-2 format (e.g., "eip155:84532")
    payTo: string;            // Your wallet address
  }>;
  description?: string;       // Description of the resource
  mimeType?: string;          // MIME type of the response
  extensions?: object;        // Optional extensions (e.g., Bazaar)
}

```

--------------------------------

### Add Payment Middleware to Node.js Next.js App

Source: https://docs.cdp.coinbase.com/x402/quickstart-for-sellers

This snippet shows how to implement payment middleware in a Next.js application using the `@x402/next` package. It configures the middleware to protect the '/api/protected' route with a payment requirement using the 'exact' EVM scheme. The `middleware.ts` file handles the payment proxy logic, and `config.matcher` specifies the routes to be protected.

```typescript
// middleware.ts
import { paymentProxy, x402ResourceServer } from "@x402/next";
import { ExactEvmScheme } from "@x402/evm/exact/server";
import { HTTPFacilitatorClient } from "@x402/core/server";

const payTo = "0xYourAddress";

const facilitatorClient = new HTTPFacilitatorClient({
  url: "https://x402.org/facilitator"
});

const server = new x402ResourceServer(facilitatorClient)
  .register("eip155:84532", new ExactEvmScheme());

export const middleware = paymentProxy(
  {
    "/api/protected": {
      accepts: [
        {
          scheme: "exact",
          price: "$0.01",
          network: "eip155:84532",
          payTo,
        },
      ],
      description: "Access to protected content",
      mimeType: "application/json",
    },
  },
  server,
);

export const config = {
  matcher: ["/api/protected/:path*"],
};

```

--------------------------------

### Configure Base Network (CAIP-2)

Source: https://docs.cdp.coinbase.com/x402/quickstart-for-sellers

This snippet demonstrates how to configure the CDP facilitator for the Base mainnet and Sepolia testnet using CAIP-2 identifiers. It specifies the network, price, and payment address.

```typescript
    // Base mainnet
    {
      scheme: "exact",
      price: "$0.001",
      network: "eip155:8453", // Base mainnet
      payTo: "0xYourAddress",
    }

    // Base Sepolia testnet
    {
      scheme: "exact",
      price: "$0.001",
      network: "eip155:84532", // Base Sepolia
      payTo: "0xYourAddress",
    }
```

--------------------------------

### Server-Side Configuration with Node.js

Source: https://docs.cdp.coinbase.com/x402/network-support

Example of server-side payment configuration using Node.js with the x402 express middleware. It demonstrates registering an EVM scheme for Base Sepolia and setting up payment acceptance.

```typescript
import { paymentMiddleware, x402ResourceServer } from "@x402/express";
import { ExactEvmScheme } from "@x402/evm/exact/server";
import { HTTPFacilitatorClient } from "@x402/core/server";

const facilitatorClient = new HTTPFacilitatorClient({
  url: "https://x402.org/facilitator",
});

// Register scheme for Base Sepolia
const server = new x402ResourceServer(facilitatorClient)
  .register("eip155:84532", new ExactEvmScheme());

app.use(
  paymentMiddleware(
    {
      "GET /api": {
        accepts: [
          {
            scheme: "exact",
            price: "$0.001",
            network: "eip155:84532", // Base Sepolia
            payTo: "0xYourAddress",
          },
        ],
        description: "API endpoint",
      },
    },
    server,
  ),
);
```

--------------------------------

### Declare Discovery Extension for GET Endpoints (TypeScript)

Source: https://docs.cdp.coinbase.com/x402/bazaar

Configures a discovery extension for GET endpoints. It takes an `input` object for query parameters and an `inputSchema` to define the structure and types of these parameters. The `output` property defines the expected response structure.

```typescript
declareDiscoveryExtension({
  input: { city: "San Francisco" }, // Example query params
  inputSchema: {
    properties: {
      city: { type: "string", description: "City name" },
    },
    required: ["city"],
  },
  output: {
    example: { temperature: 72 },
    schema: {
      properties: {
        temperature: { type: "number" },
      },
    },
  },
});
```

--------------------------------

### Register Extension and Declare Discovery Metadata (Go Gin)

Source: https://docs.cdp.coinbase.com/x402/bazaar

This Go Gin code snippet illustrates setting up an x402 payment middleware within a Gin router. It demonstrates how to create a discovery extension for the '/weather' endpoint, specifying its output example and JSON schema. The middleware is configured with payment routes, a facilitator client, and EVM schemes. Dependencies include 'github.com/coinbase/x402/go', 'github.com/coinbase/x402/go/http', 'github.com/coinbase/x402/go/http/gin', 'github.com/coinbase/x402/go/mechanisms/evm/exact/server', 'github.com/coinbase/x402/go/extensions/bazaar', 'github.com/coinbase/x402/go/extensions/types', and 'github.com/gin-gonic/gin'.

```go
package main

import (
    "net/http"

    x402 "github.com/coinbase/x402/go"
    x402http "github.com/coinbase/x402/go/http"
    ginmw "github.com/coinbase/x402/go/http/gin"
    evm "github.com/coinbase/x402/go/mechanisms/evm/exact/server"
    "github.com/coinbase/x402/go/extensions/bazaar"
    "github.com/coinbase/x402/go/extensions/types"
    "github.com/gin-gonic/gin"
)

func main() {
    r := gin.Default()

    // Create discovery extension for the endpoint
    discoveryExt, _ := bazaar.DeclareDiscoveryExtension(
        types.MethodGET,
        nil, // No query params required
        nil, // No input schema
        "",  // Not a body method
        &types.OutputConfig{
            Example: map[string]interface{}{
                "temperature": 72,
                "conditions":  "sunny",
                "humidity":    45,
            },
            Schema: types.JSONSchema{
                "properties": map[string]interface{}{
                    "temperature": map[string]interface{}{"type": "number"},
                    "conditions":  map[string]interface{}{"type": "string"},
                    "humidity":    map[string]interface{}{"type": "number"},
                },
                "required": []string{"temperature", "conditions"},
            },
        },
    )

    r.Use(ginmw.X402Payment(ginmw.Config{
        Routes: x402http.RoutesConfig{
            "GET /weather": {
                Scheme:  "exact",
                PayTo:   "0xYourAddress",
                Price:   "$0.001",
                Network: x402.Network("eip155:84532"),
                Extensions: map[string]interface{}{
                    types.BAZAAR: discoveryExt,
                },
            },
        },
        Facilitator: x402http.NewHTTPFacilitatorClient(&x402http.FacilitatorConfig{
            URL: "https://x402.org/facilitator",
        }),
        Schemes: []ginmw.SchemeConfig{
            {Network: x402.Network("eip155:84532"), Server: evm.NewExactEvmScheme()},
        },
    }))

    r.GET("/weather", func(c *gin.Context) {
        c.JSON(http.StatusOK, gin.H{
            "temperature": 72,
            "conditions":  "sunny",
            "humidity":    45,
        })
    })

    r.Run(":4021")
}

```

--------------------------------

### Configure Solana Network (CAIP-2)

Source: https://docs.cdp.coinbase.com/x402/quickstart-for-sellers

This snippet shows how to configure the CDP facilitator for Solana mainnet and devnet using CAIP-2 identifiers. It requires a Solana wallet address (base58 format) for payments.

```typescript
    // Solana mainnet
    {
      scheme: "exact",
      price: "$0.001",
      network: "solana:5eykt4UsFv8P8NJdTREpY1vzqKqZKvdp", // Solana mainnet
      payTo: "YourSolanaWalletAddress",
    }

    // Solana devnet
    {
      scheme: "exact",
      price: "$0.001",
      network: "solana:EtWTRABZaYq6iMfeYKouRu166VU2xqa1", // Solana devnet
      payTo: "YourSolanaWalletAddress",
    }
```

--------------------------------

### Instantiate Solana Signer in Node.js

Source: https://docs.cdp.coinbase.com/x402/quickstart-for-buyers

Creates a Solana signer using a base58 encoded private key stored in an environment variable, utilizing SolanaKit for cryptographic operations.

```typescript
import { createKeyPairSignerFromBytes } from "@solana/kit";
import { base58 } from "@scure/base";

// 64-byte base58 secret key (private + public)
const svmSigner = await createKeyPairSignerFromBytes(
  base58.decode(process.env.SOLANA_PRIVATE_KEY!),
);
```

--------------------------------

### Initialize Client-Side EVM and Solana Schemes (TypeScript)

Source: https://docs.cdp.coinbase.com/x402/migration-guide

Shows how to initialize an x402 client and register both EVM and Solana schemes for client-side payment processing. This allows the client to handle payments seamlessly across both network types.

```typescript
import { registerExactEvmScheme } from "@x402/evm/exact/client";
import { registerExactSvmScheme } from "@x402/svm/exact/client";

const client = new x402Client();
registerExactEvmScheme(client, { signer: evmSigner });
registerExactSvmScheme(client, { signer: svmSigner });

// Client automatically handles both EVM and Solana payments
```

--------------------------------

### Configure v1 Route for Weather Data

Source: https://docs.cdp.coinbase.com/x402/migration-guide

This snippet shows the v1 route configuration for accessing weather data. It specifies the price, network, and a basic configuration object.

```typescript
{
  "GET /weather": {
    price: "$0.001",
    network: "base-sepolia",
    config: {
      description: "Weather data",
      mimeType: "application/json"
    }
  }
}
```

--------------------------------

### Add Payment Middleware to Node.js Express App

Source: https://docs.cdp.coinbase.com/x402/quickstart-for-sellers

This snippet demonstrates how to integrate the payment middleware into a Node.js Express application. It requires the `@x402/express` package and configures payment for a specific route using the 'exact' EVM scheme. The middleware intercepts requests to the '/weather' route, enforcing payment before allowing access.

```typescript
import express from "express";
import { paymentMiddleware, x402ResourceServer } from "@x402/express";
import { ExactEvmScheme } from "@x402/evm/exact/server";
import { HTTPFacilitatorClient } from "@x402/core/server";

const app = express();

// Your receiving wallet address
const payTo = "0xYourAddress";

// Create facilitator client (testnet)
const facilitatorClient = new HTTPFacilitatorClient({
  url: "https://x402.org/facilitator"
});

// Create resource server and register EVM scheme
const server = new x402ResourceServer(facilitatorClient)
  .register("eip155:84532", new ExactEvmScheme());

app.use(
  paymentMiddleware(
    {
      "GET /weather": {
        accepts: [
          {
            scheme: "exact",
            price: "$0.001", // USDC amount in dollars
            network: "eip155:84532", // Base Sepolia (CAIP-2 format)
            payTo,
          },
        ],
        description: "Get current weather data for any location",
        mimeType: "application/json",
      },
    },
    server,
  ),
);

// Implement your route
app.get("/weather", (req, res) => {
  res.send({
    report: {
      weather: "sunny",
      temperature: 70,
    },
  });
});

app.listen(4021, () => {
  console.log(`Server listening at http://localhost:4021`);
});

```

--------------------------------

### Add Discovery Metadata to Endpoint Configuration (TypeScript)

Source: https://docs.cdp.coinbase.com/x402/quickstart-for-sellers

This snippet shows how to add descriptive metadata to an endpoint configuration for discovery on the x402 Bazaar. It includes fields for description, mimeType, and bazaar extensions like discoverable, category, and tags. This metadata helps AI agents and developers understand and find services.

```typescript
{
  "GET /weather": {
    accepts: [
      {
        scheme: "exact",
        price: "$0.001",
        network: "eip155:8453",
        payTo: "0xYourAddress",
      },
    ],
    description: "Get real-time weather data including temperature, conditions, and humidity",
    mimeType: "application/json",
    extensions: {
      bazaar: {
        discoverable: true,
        category: "weather",
        tags: ["forecast", "real-time"],
      },
    },
  },
}
```

--------------------------------

### x402 v2 Package Dependencies (JSON)

Source: https://docs.cdp.coinbase.com/x402/mcp-server

Lists the necessary x402 v2 packages and their versions required for the example project. This includes SDKs for Model Context Protocol, Axios, EVM, and SVM, along with general libraries like axios, viem, Solana kit, and Scure base.

```json
{
  "dependencies": {
    "@modelcontextprotocol/sdk": "^1.9.0",
    "@x402/axios": "workspace:*",
    "@x402/evm": "workspace:*",
    "@x402/svm": "workspace:*",
    "axios": "^1.13.2",
    "viem": "^2.39.0",
    "@solana/kit": "^2.1.1",
    "@scure/base": "^1.2.6"
  }
}
```

--------------------------------

### Node.js: Automatically Handle 402 Payments with @x402/axios

Source: https://docs.cdp.coinbase.com/x402/quickstart-for-buyers

The @x402/axios package integrates a payment interceptor with Axios, enabling automatic retries of requests with payment headers upon encountering a 402 error. It relies on dependencies such as `@x402/axios`, `@x402/evm/exact/client`, `viem`, and `axios`. The input is an Axios instance and the x402 client, and the output includes the response data and payment settlement details in the headers.

```typescript
import { x402Client, withPaymentInterceptor, x402HTTPClient } from "@x402/axios";
import { registerExactEvmScheme } from "@x402/evm/exact/client";
import { privateKeyToAccount } from "viem/accounts";
import axios from "axios";

// Create signer
const signer = privateKeyToAccount(process.env.EVM_PRIVATE_KEY as `0x${string}`);

// Create x402 client and register schemes
const client = new x402Client();
registerExactEvmScheme(client, { signer });

// Create an Axios instance with payment handling
const api = withPaymentInterceptor(
  axios.create({ baseURL: "https://api.example.com" }),
  client,
);

// Make request - payment is handled automatically
const response = await api.get("/paid-endpoint");
console.log("Response:", response.data);

// Get payment receipt
const httpClient = new x402HTTPClient(client);
const paymentResponse = httpClient.getPaymentSettleResponse(
  (name) => response.headers[name.toLowerCase()]
);
console.log("Payment settled:", paymentResponse);
```

--------------------------------

### Configure v2 Route for Weather Data with Enhanced Payment Options

Source: https://docs.cdp.coinbase.com/x402/migration-guide

This snippet demonstrates the v2 route configuration for weather data, introducing an `accepts` array for flexible payment options and CAIP-2 network format.

```typescript
{
  "GET /weather": {
    accepts: [
      {
        scheme: "exact",
        price: "$0.001",
        network: "eip155:84532",
        payTo: "0xYourAddress"
      }
    ],
    description: "Weather data",
    mimeType: "application/json"
  }
}
```

--------------------------------

### Register Server-Side EVM and Solana Schemes (TypeScript)

Source: https://docs.cdp.coinbase.com/x402/migration-guide

Demonstrates how to set up a server-side resource server that registers Exact EVM and Solana schemes for specific networks. This enables the server to handle payments across different blockchain networks.

```typescript
import { ExactEvmScheme } from "@x402/evm/exact/server";
import { ExactSvmScheme } from "@x402/svm/exact/server";

const server = new x402ResourceServer(facilitatorClient)
  .register("eip155:8453", new ExactEvmScheme())
  .register("eip155:84532", new ExactEvmScheme())
  .register("solana:5eykt4UsFv8P8NJdTREpY1vzqKqZKvdp", new ExactSvmScheme());

// Endpoint accepting multiple networks
{
  "GET /api": {
    accepts: [
      { scheme: "exact", price: "$0.01", network: "eip155:8453", payTo: evmAddress },
      { scheme: "exact", price: "$0.01", network: "solana:5eykt4UsFv8P8NJdTREpY1vzqKqZKvdp", payTo: solanaAddress },
    ],
  },
}
```

--------------------------------

### Create Protected API Route with x402

Source: https://docs.cdp.coinbase.com/x402/miniapps

Defines a protected API route in Next.js using `@x402/next`'s `withX402` HOC. It sets up an x402 resource server, registers the EVM scheme, and specifies payment requirements for accessing the endpoint. This example demonstrates creating a premium content endpoint.

```typescript
// app/api/premium/route.ts
import { NextRequest, NextResponse } from "next/server";
import { withX402 } from "@x402/next";
import { x402ResourceServer, HTTPFacilitatorClient } from "@x402/core/server";
import { registerExactEvmScheme } from "@x402/evm/exact/server";

const facilitatorClient = new HTTPFacilitatorClient({
  url: process.env.FACILITATOR_URL,
});

const server = new x402ResourceServer(facilitatorClient);
registerExactEvmScheme(server);

const handler = async (_: NextRequest) => {
  return NextResponse.json({ message: "Premium content!" });
};

export const GET = withX402(
  handler,
  {
    accepts: [
      {
        scheme: "exact",
        price: "$0.10", // Higher price for premium content
        network: "eip155:84532",
        payTo: process.env.EVM_ADDRESS as `0x${string}`,
      },
    ],
    description: "Premium content access",
    mimeType: "application/json",
  },
  server,
);

```

--------------------------------

### Go: Decode Payment Response

Source: https://docs.cdp.coinbase.com/x402/quickstart-for-buyers

Decodes a JSON payment response from an HTTP response body and checks for a specific payment header to confirm successful settlement. This is useful for verifying the status of a payment transaction.

```go
import (
    "encoding/json"
    "fmt"
    "net/http"
)

// Assuming 'resp' is an *http.Response
data := make(map[string]interface{})
json.NewDecoder(resp.Body).Decode(&data)
fmt.Printf("Response: %+v\n", data)

// Check payment response header
paymentHeader := resp.Header.Get("PAYMENT-RESPONSE")
if paymentHeader != "" {
    fmt.Println("Payment settled successfully!")
}
```

--------------------------------

### Register Extension and Declare Discovery Metadata (Node.js Express)

Source: https://docs.cdp.coinbase.com/x402/bazaar

This Node.js Express code snippet demonstrates how to set up an x402 resource server, register extensions including bazaar and EVM schemes, and configure payment middleware. It specifically shows how to declare discovery metadata for the '/weather' endpoint, detailing its output schema and an example response. Dependencies include express, @x402/express, @x402/core/server, @x402/evm/exact/server, and @x402/extensions/bazaar.

```typescript
import express from "express";
import { paymentMiddleware } from "@x402/express";
import { x402ResourceServer, HTTPFacilitatorClient } from "@x402/core/server";
import { registerExactEvmScheme } from "@x402/evm/exact/server";
import {
  bazaarResourceServerExtension,
  declareDiscoveryExtension,
} from "@x402/extensions/bazaar";

const app = express();

// Create facilitator client
const facilitatorClient = new HTTPFacilitatorClient({
  url: "https://x402.org/facilitator",
});

// Create resource server and register extensions
const server = new x402ResourceServer(facilitatorClient);
registerExactEvmScheme(server);
server.registerExtension(bazaarResourceServerExtension);

// Configure payment middleware with discovery metadata
app.use(
  paymentMiddleware(
    {
      "GET /weather": {
        accepts: {
          scheme: "exact",
          price: "$0.001",
          network: "eip155:84532",
          payTo: "0xYourAddress",
        },
        extensions: {
          // Declare discovery metadata for this endpoint
          ...declareDiscoveryExtension({
            output: {
              example: {
                temperature: 72,
                conditions: "sunny",
                humidity: 45,
              },
              schema: {
                properties: {
                  temperature: { type: "number" },
                  conditions: { type: "string" },
                  humidity: { type: "number" },
                },
                required: ["temperature", "conditions"],
              },
            },
          }),
        },
      },
    },
    server,
  ),
);

app.get("/weather", (req, res) => {
  res.json({
    temperature: 72,
    conditions: "sunny",
    humidity: 45,
  });
});

app.listen(4021);

```

--------------------------------

### MCP Server Setup with X402 Axios for EVM/SVM Payments (TypeScript)

Source: https://docs.cdp.coinbase.com/x402/mcp-server

This snippet shows the complete implementation of an MCP server using TypeScript. It configures an Axios client with automatic payment handling via the @x402/axios library, supporting both EVM and SVM private keys for transactions. The server exposes a tool to fetch data from a resource server, automatically managing payment requirements when a 402 response is encountered.

```typescript
import { McpServer } from "@modelcontextprotocol/sdk/server/mcp.js";
import { StdioServerTransport } from "@modelcontextprotocol/sdk/server/stdio.js";
import axios from "axios";
import { x402Client, wrapAxiosWithPayment } from "@x402/axios";
import { registerExactEvmScheme } from "@x402/evm/exact/client";
import { registerExactSvmScheme } from "@x402/svm/exact/client";
import { privateKeyToAccount } from "viem/accounts";
import { createKeyPairSignerFromBytes } from "@solana/kit";
import { base58 } from "@scure/base";
import { config } from "dotenv";

config();

const evmPrivateKey = process.env.EVM_PRIVATE_KEY as `0x${string}`;
const svmPrivateKey = process.env.SVM_PRIVATE_KEY as string;
const baseURL = process.env.RESOURCE_SERVER_URL || "http://localhost:4021";
const endpointPath = process.env.ENDPOINT_PATH || "/weather";

if (!evmPrivateKey && !svmPrivateKey) {
  throw new Error("At least one of EVM_PRIVATE_KEY or SVM_PRIVATE_KEY must be provided");
}

/**
 * Creates an axios client configured with x402 payment support for EVM and/or SVM.
 */
async function createClient() {
  const client = new x402Client();

  // Register EVM scheme if private key is provided
  if (evmPrivateKey) {
    const evmSigner = privateKeyToAccount(evmPrivateKey);
    registerExactEvmScheme(client, { signer: evmSigner });
  }

  // Register SVM scheme if private key is provided
  if (svmPrivateKey) {
    const svmSigner = await createKeyPairSignerFromBytes(base58.decode(svmPrivateKey));
    registerExactSvmScheme(client, { signer: svmSigner });
  }

  return wrapAxiosWithPayment(axios.create({ baseURL }), client);
}

async function main() {
  const api = await createClient();

  // Create an MCP server
  const server = new McpServer({
    name: "x402 MCP Client Demo",
    version: "2.0.0",
  });

  // Add a tool that calls the paid API
  server.tool(
    "get-data-from-resource-server",
    "Get data from the resource server (in this example, the weather)",
    {},
    async () => {
      const res = await api.get(endpointPath);
      return {
        content: [{ type: "text", text: JSON.stringify(res.data) }],
      };
    },
  );

  const transport = new StdioServerTransport();
  await server.connect(transport);
}

main().catch(error => {
  console.error(error);
  process.exit(1);
});

```

--------------------------------

### Integrate x402 Payment Middleware with Express.js

Source: https://docs.cdp.coinbase.com/x402/support/github

This snippet demonstrates how to integrate the x402 payment middleware into an Express.js application. It configures the middleware to handle specific HTTP GET requests, such as weather data, by defining accepted schemes and endpoint descriptions. The `paymentMiddleware` function and associated configurations are key components for enabling x402 payments.

```javascript
app.use(
  paymentMiddleware(
    {
      "GET /weather": {
        accepts: [...],                 // As many networks / schemes as you want to support
        description: "Weather data",    // what your endpoint does
      },
    },
  ),
);
// That's it! See examples/ for full details
```

--------------------------------

### Wallet Integration with OnchainKit

Source: https://docs.cdp.coinbase.com/x402/miniapps

Explains how to integrate wallets using OnchainKit, including setting up the provider and configuring MiniKit for Farcaster integration.

```APIDOC
## Wallet Integration with OnchainKit

### Description
This section describes the integration of wallet functionalities using the OnchainKit library, commonly used with wagmi for blockchain interactions. It covers the provider setup and configuration options, including enabling the MiniKit for Farcaster.

### Method
N/A (Provider Setup)

### Endpoint
N/A (Provider Setup)

### Parameters
N/A

### Request Example
```typescript
// app/providers.tsx
"use client";

import { baseSepolia } from "wagmi/chains";
import { OnchainKitProvider } from "@coinbase/onchainkit";

export function Providers({ children }: { children: React.ReactNode }) {
  return (
    <OnchainKitProvider
      apiKey={process.env.NEXT_PUBLIC_ONCHAINKIT_API_KEY}
      chain={baseSepolia}
      config={{
        appearance: {
          mode: "auto", // 'light' | 'dark' | 'auto'
        },
        wallet: {
          display: "modal", // 'modal' | 'drawer'
          preference: "all", // 'all' | 'smartWalletOnly' | 'eoaOnly'
        },
      }}
      miniKit={{
        enabled: true,
      }}
    >
      {children}
    </OnchainKitProvider>
  );
}
```

### Response
N/A
```

--------------------------------

### Client-Side Payment Handling

Source: https://docs.cdp.coinbase.com/x402/miniapps

Demonstrates how to set up and use the @x402/fetch library for automatic payment handling on the client-side. It includes converting a wagmi/viem WalletClient to an x402 ClientEvmSigner and wrapping the fetch API.

```APIDOC
## Client-Side Payment Handling

### Description
This section details the client-side implementation for handling payments automatically using the `@x402/fetch` library. It involves integrating with a connected wallet (e.g., via wagmi/viem) and wrapping the standard `fetch` function to include payment logic.

### Method
GET

### Endpoint
`/api/protected` (example)

### Parameters
#### Query Parameters
None

#### Request Body
None

### Request Example
```typescript
// app/page.tsx
"use client";

import { x402Client, wrapFetchWithPayment } from "@x402/fetch";
import { registerExactEvmScheme } from "@x402/evm/exact/client";
import type { ClientEvmSigner } from "@x402/evm";
import type { WalletClient, Account } from "viem";
import { useWalletClient } from "wagmi";

function wagmiToClientSigner(walletClient: WalletClient): ClientEvmSigner {
  if (!walletClient.account) {
    throw new Error("Wallet client must have an account");
  }

  return {
    address: walletClient.account.address,
    signTypedData: async (message) => {
      const signature = await walletClient.signTypedData({
        account: walletClient.account as Account,
        domain: message.domain,
        types: message.types,
        primaryType: message.primaryType,
        message: message.message,
      });
      return signature;
    },
  };
}

export default function App() {
  const { data: walletClient } = useWalletClient();

  const handleProtectedAction = async () => {
    if (!walletClient) {
      console.error("Wallet not connected");
      return;
    }

    const client = new x402Client();
    const signer = wagmiToClientSigner(walletClient);
    registerExactEvmScheme(client, { signer });

    const fetchWithPayment = wrapFetchWithPayment(fetch, client);

    const response = await fetchWithPayment("/api/protected", {
      method: "GET",
    });

    const data = await response.json();
    console.log("Response:", data);
  };

  return (
    <button onClick={handleProtectedAction}>
      Call Protected API ($0.01)
    </button>
  );
}
```

### Response
#### Success Response (200)
- **data** (object) - The JSON response from the protected API.
```

--------------------------------

### Query Discovery Endpoint and Make Paid Request (Go)

Source: https://docs.cdp.coinbase.com/x402/bazaar

This Go snippet demonstrates querying a facilitator's discovery endpoint for services. It uses the standard `net/http` package to fetch resources and then custom x402 libraries for making a paid request. The EVM exact scheme is registered for handling payments. Requires the 'github.com/coinbase/x402/go', 'github.com/coinbase/x402/go/http', and 'github.com/coinbase/x402/go/mechanisms/evm/exact/client' packages.

```go
package main

import (
    "encoding/json"
    "fmt"
    "net/http"
    "os"

    x402 "github.com/coinbase/x402/go"
    x402http "github.com/coinbase/x402/go/http"
    evm "github.com/coinbase/x402/go/mechanisms/evm/exact/client"
)

func main() {
    facilitatorURL := "https://x402.org/facilitator"

    // Query discovery endpoint
    resp, err := http.Get(facilitatorURL + "/discovery/resources?type=http&limit=20")
    if err != nil {
        panic(err)
    }
    defer resp.Body.Close()

    var discovery struct {
        X402Version int `json:"x402Version"`
        Items []struct {
            Resource    string                   `json:"resource"`
            Type        string                   `json:"type"`
            X402Version int                      `json:"x402Version"`
            Accepts     []map[string]interface{} `json:"accepts"`
            LastUpdated string                   `json:"lastUpdated"`
            Metadata    map[string]interface{}   `json:"metadata"`
        } `json:"items"`
        Pagination struct {
            Limit  int `json:"limit"`
            Offset int `json:"offset"`
            Total  int `json:"total"`
        } `json:"pagination"`
    }
    json.NewDecoder(resp.Body).Decode(&discovery)

    fmt.Printf("Found %d services\n", len(discovery.Items))

    // Select a service
    if len(discovery.Items) == 0 {
        fmt.Println("No services found")
        return
    }
    selectedResource := discovery.Items[0].Resource

    // Create x402 client for payments
    client := x402.NewX402Client()
    evm.RegisterExactEvmScheme(client, &evm.Config{
        PrivateKey: os.Getenv("EVM_PRIVATE_KEY"),
    })

    // Make paid request
    httpClient := x402.WrapHTTPClient(client)
    req, _ := http.NewRequest("GET", selectedResource, nil)
    paymentResp, err := httpClient.Do(req)
    if err != nil {
        panic(err)
    }
    defer paymentResp.Body.Close()

    var data map[string]interface{}]
    json.NewDecoder(paymentResp.Body).Decode(&data)
    fmt.Printf("Response: %+v\n", data)
}

```

--------------------------------

### Registering Exact EVM Scheme for x402

Source: https://docs.cdp.coinbase.com/x402/support/faq

Demonstrates how to register the Exact EVM scheme for both client-side and server-side x402 implementations. This involves importing the necessary functions and classes, instantiating the client/server, and registering the scheme with specific network configurations.

```typescript
import { registerExactEvmScheme } from "@x402/evm/exact/client";
const client = new x402Client();
registerExactEvmScheme(client, { signer });

import { ExactEvmScheme } from "@x402/evm/exact/server";
const server = new x402ResourceServer(facilitatorClient)
  .register("eip155:8453", new ExactEvmScheme());
```

--------------------------------

### Handle Payments with @x402/fetch and Wagmi

Source: https://docs.cdp.coinbase.com/x402/miniapps

Demonstrates how to use the x402 client to wrap the fetch API for automatic payment handling. It converts a wagmi/viem WalletClient to a ClientEvmSigner and registers the EVM scheme for payment processing. This is used for making requests to protected API endpoints.

```typescript
"use client";

import { x402Client, wrapFetchWithPayment } from "@x402/fetch";
import { registerExactEvmScheme } from "@x402/evm/exact/client";
import type { ClientEvmSigner } from "@x402/evm";
import type { WalletClient, Account } from "viem";
import { useWalletClient } from "wagmi";

/**
 * Converts a wagmi/viem WalletClient to a ClientEvmSigner for x402Client
 */
function wagmiToClientSigner(walletClient: WalletClient): ClientEvmSigner {
  if (!walletClient.account) {
    throw new Error("Wallet client must have an account");
  }

  return {
    address: walletClient.account.address,
    signTypedData: async (message) => {
      const signature = await walletClient.signTypedData({
        account: walletClient.account as Account,
        domain: message.domain,
        types: message.types,
        primaryType: message.primaryType,
        message: message.message,
      });
      return signature;
    },
  };
}

export default function App() {
  const { data: walletClient } = useWalletClient();

  const handleProtectedAction = async () => {
    if (!walletClient) {
      console.error("Wallet not connected");
      return;
    }

    // Create x402 client and register EVM scheme with wagmi signer
    const client = new x402Client();
    const signer = wagmiToClientSigner(walletClient);
    registerExactEvmScheme(client, { signer });

    // Wrap fetch with payment handling
    const fetchWithPayment = wrapFetchWithPayment(fetch, client);

    // Make request - payment is handled automatically
    const response = await fetchWithPayment("/api/protected", {
      method: "GET",
    });

    const data = await response.json();
    console.log("Response:", data);
  };

  return (
    <button onClick={handleProtectedAction}>
      Call Protected API ($0.01)
    </button>
  );
}

```

--------------------------------

### Integrate Wallet with OnchainKit Provider

Source: https://docs.cdp.coinbase.com/x402/miniapps

Sets up the OnchainKit provider for wallet integration, enabling MiniKit for Farcaster. It configures the API key, chain, and appearance settings for the wallet modal. This is crucial for managing user wallets on the frontend.

```typescript
"use client";

import { baseSepolia } from "wagmi/chains";
import { OnchainKitProvider } from "@coinbase/onchainkit";

export function Providers({ children }: { children: React.ReactNode }) {
  return (
    <OnchainKitProvider
      apiKey={process.env.NEXT_PUBLIC_ONCHAINKIT_API_KEY}
      chain={baseSepolia}
      config={{
        appearance: {
          mode: "auto", // 'light' | 'dark' | 'auto'
        },
        wallet: {
          display: "modal", // 'modal' | 'drawer'
          preference: "all", // 'all' | 'smartWalletOnly' | 'eoaOnly'
        },
      }}
      miniKit={{
        enabled: true,
      }}
    >
      {children}
    </OnchainKitProvider>
  );
}

```

--------------------------------

### Configure Claude Desktop MCP Server

Source: https://docs.cdp.coinbase.com/x402/mcp-server

This JSON configuration object defines an MCP server named 'demo' for Claude Desktop. It specifies the command to run the server ('pnpm dev'), its working directory, and necessary environment variables including private keys for EVM and Solana wallets, the resource server URL, and the endpoint path. Ensure the absolute path to the repo is correctly set.

```json
{
  "mcpServers": {
    "demo": {
      "command": "pnpm",
      "args": [
        "--silent",
        "-C",
        "<absolute path to this repo>/examples/typescript/clients/mcp",
        "dev"
      ],
      "env": {
        "EVM_PRIVATE_KEY": "<private key of a wallet with USDC on Base Sepolia>",
        "SVM_PRIVATE_KEY": "<base58-encoded private key of a Solana wallet with USDC on Devnet>",
        "RESOURCE_SERVER_URL": "http://localhost:4021",
        "ENDPOINT_PATH": "/weather"
      }
    }
  }
}
```

--------------------------------

### POST /api/premium

Source: https://docs.cdp.coinbase.com/x402/miniapps

This endpoint demonstrates how to create a protected route on the backend using Next.js and the `@x402/next` middleware. It defines payment requirements for accessing premium content.

```APIDOC
## POST /api/premium

### Description
This endpoint serves premium content and requires a payment of $0.10 via the 'exact' EVM scheme on the `eip155:84532` network. It utilizes the `@x402/next` middleware to enforce payment.

### Method
GET

### Endpoint
`/api/premium`

### Parameters
#### Path Parameters
None

#### Query Parameters
None

#### Request Body
None

### Request Example
```typescript
// app/api/premium/route.ts
import { NextRequest, NextResponse } from "next/server";
import { withX402 } from "@x402/next";
import { x402ResourceServer, HTTPFacilitatorClient } from "@x402/core/server";
import { registerExactEvmScheme } from "@x402/evm/exact/server";

const facilitatorClient = new HTTPFacilitatorClient({
  url: process.env.FACILITATOR_URL,
});

const server = new x402ResourceServer(facilitatorClient);
registerExactEvmScheme(server);

const handler = async (_: NextRequest) => {
  return NextResponse.json({ message: "Premium content!" });
};

export const GET = withX402(
  handler,
  {
    accepts: [
      {
        scheme: "exact",
        price: "$0.10", // Higher price for premium content
        network: "eip155:84532",
        payTo: process.env.EVM_ADDRESS as `0x${string}`,
      },
    ],
    description: "Premium content access",
    mimeType: "application/json",
  },
  server,
);
```

### Response
#### Success Response (200)
- **message** (string) - A confirmation message indicating access to premium content.
```

--------------------------------

### Query Discovery Endpoint and Make Paid Request (Node.js)

Source: https://docs.cdp.coinbase.com/x402/bazaar

This Node.js snippet demonstrates how to query a facilitator's discovery endpoint to find available services. It initializes an HTTPFacilitatorClient, lists resources filtered by type and limit, and then makes a paid request to the first discovered service using the x402 client with EVM exact scheme for payments. Requires the '@x402/core/http', '@x402/extensions/bazaar', '@x402/fetch', '@x402/evm/exact/client', and 'viem/accounts' libraries.

```typescript
import { HTTPFacilitatorClient } from "@x402/core/http";
import { withBazaar } from "@x402/extensions/bazaar";
import { x402Client, wrapFetchWithPayment } from "@x402/fetch";
import { registerExactEvmScheme } from "@x402/evm/exact/client";
import { privateKeyToAccount } from "viem/accounts";

// Create facilitator client with Bazaar extension
const facilitatorClient = withBazaar(
  new HTTPFacilitatorClient({ url: "https://x402.org/facilitator" })
);

// Query available services
const discovery = await facilitatorClient.extensions.discovery.listResources({
  type: "http",   // Filter by protocol type
  limit: 20,      // Pagination
  offset: 0,
});

console.log(`Found ${discovery.items.length} services`);

// Browse discovered resources
for (const resource of discovery.items) {
  console.log(`- ${resource.resource}`);
  console.log(`  Type: ${resource.type}`);
  console.log(`  x402 Version: ${resource.x402Version}`);
  console.log(`  Accepts: ${resource.accepts.length} payment method(s)`);
  console.log(`  Last Updated: ${resource.lastUpdated}`);
  if (resource.metadata) {
    console.log(`  Metadata:`, resource.metadata);
  }
}

// Select a service and make a paid request
const selectedService = discovery.items[0];

// Set up x402 client for payments
const signer = privateKeyToAccount(process.env.EVM_PRIVATE_KEY as `0x${string}`);
const client = new x402Client();
registerExactEvmScheme(client, { signer });

const fetchWithPayment = wrapFetchWithPayment(fetch, client);

// Call the discovered service
const response = await fetchWithPayment(selectedService.resource);
const data = await response.json();
console.log("Response:", data);

```

--------------------------------

### Check Mini App Context (TypeScript)

Source: https://docs.cdp.coinbase.com/x402/miniapps

This TypeScript code snippet attempts to initialize the SDK and check if the current environment is within a Mini App context. It includes a try-catch block to handle cases where the SDK might not be available (e.g., outside Farcaster).

```typescript
// SDK may not be available outside Farcaster
try {
  await sdk.actions.ready();
  const isInMiniApp = await sdk.isInMiniApp();
} catch (error) {
  console.log("Not running in Mini App context");
}
```

--------------------------------

### Troubleshooting Base Sepolia vs. Base Mainnet Issues

Source: https://docs.cdp.coinbase.com/x402/support/faq

Offers guidance on resolving issues that occur when a test on Base Sepolia works but fails on Base mainnet, covering network configurations, facilitator support, and gas fees.

```APIDOC
### My test works on Base Sepolia but fails on Base mainnet. What changed?

*   Ensure you set `network: "eip155:8453"` (not `"eip155:84532"` for testnet).
*   Make sure you're using a facilitator that supports mainnet (the x402.org testnet facilitator does NOT support mainnet).
*   Confirm you have the correct asset address for the network you're using.
*   Confirm your wallet has **mainnet** USDC.
*   Gas fees are higher on mainnet; fund the wallet with a small amount of ETH for gas.

### Method

N/A (Troubleshooting steps)

### Endpoint

N/A (Troubleshooting steps)

### Parameters

N/A

### Request Example

N/A

### Response

N/A
```

--------------------------------

### Price Formatting with x402

Source: https://docs.cdp.coinbase.com/x402/network-support

Demonstrates how to format prices in x402, supporting both human-readable dollar strings and atomic units for precision. The default decimals are 6.

```typescript
// Dollar string format (recommended for readability)
price: "$0.001"    // 0.001 USDC
price: "$1.00"     // 1 USDC
price: "$0.50"     // 0.50 USDC

// Atomic units (for precision)
amount: "1000"     // 0.001 USDC (6 decimals)
amount: "1000000"  // 1 USDC (6 decimals)
```

--------------------------------

### Check Wallet Client Availability (TypeScript)

Source: https://docs.cdp.coinbase.com/x402/miniapps

This TypeScript code demonstrates how to check if a wallet client is available before attempting to make payment-related requests. It includes error handling for when the client is not available.

```typescript
// Ensure wallet client is available before making requests
if (!walletClient) {
  console.error("Wallet client not available");
  return;
}
```

--------------------------------

### Configuring X402 Client for Multi-Network Payments (TypeScript)

Source: https://docs.cdp.coinbase.com/x402/mcp-server

This code snippet demonstrates how to initialize the @x402/axios client to support payments across multiple blockchain networks, specifically EVM (like Ethereum and Base) and Solana. It shows the registration of respective payment schemes and how the wrapped HTTP client can then automatically handle transactions on these networks based on server requirements.

```typescript
import { x402Client, wrapAxiosWithPayment } from "@x402/axios";
import { registerExactEvmScheme } from "@x402/evm/exact/client";
import { registerExactSvmScheme } from "@x402/svm/exact/client";

const client = new x402Client();

// Register EVM scheme for Base/Ethereum payments
registerExactEvmScheme(client, { signer: evmSigner });

// Register SVM scheme for Solana payments
registerExactSvmScheme(client, { signer: svmSigner });

// Now handles both EVM and Solana networks automatically
const httpClient = wrapAxiosWithPayment(axios.create({ baseURL }), client);

```

--------------------------------

### Farcaster Mini App Detection

Source: https://docs.cdp.coinbase.com/x402/miniapps

Shows how to detect if the application is running within the Farcaster environment using the Mini App SDK.

```APIDOC
## Farcaster Mini App Detection

### Description
This code snippet demonstrates how to detect whether the current application is running inside a Farcaster Mini App environment using the Farcaster Mini App SDK.

### Method
N/A

### Endpoint
N/A

### Parameters
N/A

### Request Example
```typescript
import { sdk } from "@farcaster/miniapp-sdk";

useEffect(() => {
  const initMiniApp = async () => {
    await sdk.actions.ready();
    const isInMiniApp = await sdk.isInMiniApp();
    console.log("Running in Mini App:", isInMiniApp);
  };
  initMiniApp();
}, []);
```

### Response
N/A
```

--------------------------------

### Troubleshooting 'No Scheme Registered' Errors

Source: https://docs.cdp.coinbase.com/x402/support/faq

Explains how to resolve 'No scheme registered' errors by ensuring the appropriate scheme is correctly registered on both the client and server sides.

```APIDOC
### I'm seeing "No scheme registered" errors

Ensure you've registered the appropriate scheme for the network:

```typescript  theme={null}
// Client-side
import { registerExactEvmScheme } from "@x402/evm/exact/client";
const client = new x402Client();
registerExactEvmScheme(client, { signer });

// Server-side
import { ExactEvmScheme } from "@x402/evm/exact/server";
const server = new x402ResourceServer(facilitatorClient)
  .register("eip155:8453", new ExactEvmScheme());
```

### Method

N/A (Troubleshooting steps)

### Endpoint

N/A (Troubleshooting steps)

### Parameters

N/A

### Request Example

N/A

### Response

N/A
```

--------------------------------

### Protect API Routes with x402 Payment Wrapper (TypeScript)

Source: https://docs.cdp.coinbase.com/x402/miniapps

This TypeScript code demonstrates how to protect a Next.js API route using the `withX402` wrapper from the `@x402/next` SDK. It sets up payment requirements for accessing the API endpoint and handles payment validation. The handler function is only invoked after successful payment verification.

```typescript
// app/api/protected/route.ts
import { NextRequest, NextResponse } from "next/server";
import { withX402 } from "@x402/next";
import { x402ResourceServer, HTTPFacilitatorClient } from "@x402/core/server";
import { registerExactEvmScheme } from "@x402/evm/exact/server";

// Create facilitator client
const facilitatorClient = new HTTPFacilitatorClient({
  url: process.env.FACILITATOR_URL,
});

// Create x402 resource server and register EVM scheme
const server = new x402ResourceServer(facilitatorClient);
registerExactEvmScheme(server);

// Handler function - only called after payment is verified
const handler = async (_: NextRequest) => {
  return NextResponse.json({
    success: true,
    message: "Protected action completed successfully",
    timestamp: new Date().toISOString(),
    data: {
      secretMessage: "This content was paid for with x402!",
      accessedAt: Date.now(),
    },
  });
};

// Export wrapped handler with payment requirements
export const GET = withX402(
  handler,
  {
    accepts: [
      {
        scheme: "exact",
        price: "$0.01",
        network: "eip155:84532", // Base Sepolia
        payTo: process.env.EVM_ADDRESS as `0x${string}`,
      },
    ],
    description: "Access to protected Mini App API",
    mimeType: "application/json",
  },
  server,
);
```

--------------------------------

### x402 Extensions

Source: https://docs.cdp.coinbase.com/x402/support/faq

Describes the optional features or extensions that can be added to the x402 protocol, such as Bazaar for service discovery and Sign-in-with-x for authentication.

```APIDOC
### What is x402 extensions?

Extensions are optional features that can be added to the x402 protocol:

*   **Bazaar**: Service discovery extension for listing your API in the x402 marketplace
*   **Sign-in-with-x**: Authentication extension (coming soon)

Enable extensions via the `extensions` field in your route configuration.

### Method

N/A (Extension explanation)

### Endpoint

N/A (Extension explanation)

### Parameters

N/A

### Request Example

N/A

### Response

N/A
```

--------------------------------

### Refunds

Source: https://docs.cdp.coinbase.com/x402/support/faq

Explains the two current methods for handling refunds within the x402 protocol: business-logic refunds initiated by the seller and potential future escrow schemes.

```APIDOC
## Refunds

### Description

The current `exact` scheme is a **push payment** and irreversible once executed. Two options for refunds are available:

1.  **Business-logic refunds**: Seller sends a new USDC transfer back to the buyer.
2.  **Escrow schemes**: Future spec could add conditional transfers (e.g., HTLCs or hold invoices).

### Method

N/A (Conceptual explanation)

### Endpoint

N/A (Conceptual explanation)

### Parameters

N/A

### Request Example

N/A

### Response

N/A
```

--------------------------------

### Environment Variable for Facilitator URL

Source: https://docs.cdp.coinbase.com/x402/miniapps

This environment variable, `FACILITATOR_URL`, should be updated to point to the CDP facilitator for mainnet deployment. It specifies the endpoint for platform v2 x402.

```env
FACILITATOR_URL=https://api.cdp.coinbase.com/platform/v2/x402
```

--------------------------------

### Custom EVM Network Configuration

Source: https://docs.cdp.coinbase.com/x402/network-support

Demonstrates configuring x402 to use a custom EVM network, such as Ethereum mainnet, with a specified facilitator URL and token asset address.

```typescript
// Example: Using Ethereum mainnet with a custom facilitator
const facilitatorClient = new HTTPFacilitatorClient({
  url: "https://example-facilitator.com",
});

const server = new x402ResourceServer(facilitatorClient)
  .register("eip155:1", new ExactEvmScheme()); // Ethereum mainnet

app.use(
  paymentMiddleware(
    {
      "GET /api": {
        accepts: [
          {
            scheme: "exact",
            price: "$0.001",
            network: "eip155:1",
            payTo: "0xYourAddress",
            asset: "0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48", // USDC on Ethereum
          },
        ],
        description: "API endpoint",
      },
    },
    server,
  ),
);
```

--------------------------------

### Detect Farcaster Mini App Environment

Source: https://docs.cdp.coinbase.com/x402/miniapps

Utilizes the Farcaster Mini App SDK to detect if the application is running within a Farcaster Mini App environment. It initializes the SDK and logs the detection status. This is useful for adapting UI or functionality based on the execution context.

```typescript
import { sdk } from "@farcaster/miniapp-sdk";

useEffect(() => {
  const initMiniApp = async () => {
    await sdk.actions.ready();
    const isInMiniApp = await sdk.isInMiniApp();
    console.log("Running in Mini App:", isInMiniApp);
  };
  initMiniApp();
}, []);

```

--------------------------------

### x402 Schemes

Source: https://docs.cdp.coinbase.com/x402/support/github

Explains the concept of 'schemes' in the x402 protocol, which define different ways of moving money and settling payments.

```APIDOC
## Schemes

A scheme is a logical way of moving money. Blockchains allow for a large number of flexible ways to move money. To help facilitate an expanding number of payment use cases, the `x402` protocol is extensible to different ways of settling payments via its `scheme` field. Each payment scheme may have different operational functionality depending on what actions are necessary to fulfill the payment. For example `exact`, the first scheme shipping as part of the protocol, would have different behavior than `upto`. `exact` transfers a specific amount (ex: pay $1 to read an article), while a theoretical `upto` would transfer up to an amount, based on the resources consumed during a request (ex: generating tokens from an LLM).
See `specs/schemes` for more details on schemes, and see `specs/schemes/exact/scheme_exact_evm.md` to see the first proposed scheme for exact payment on EVM chains.
```

--------------------------------

### Declare Discovery Extension for POST Endpoints (TypeScript)

Source: https://docs.cdp.coinbase.com/x402/bazaar

Configures a discovery extension for POST endpoints. It accepts an `input` object for the request body, an `inputSchema` for validation, and specifies `bodyType` as 'json'. The `output` property defines the expected response structure.

```typescript
declareDiscoveryExtension({
  input: { prompt: "Hello world" }, // Example body
  inputSchema: {
    properties: {
      prompt: { type: "string", maxLength: 1000 },
    },
    required: ["prompt"],
  },
  bodyType: "json", // Signals this is a body method
  output: {
    example: { response: "Hi there!" },
  },
});
```

--------------------------------

### Multi-Network Support for Endpoints

Source: https://docs.cdp.coinbase.com/x402/network-support

Illustrates how to configure a single API endpoint to accept payments from multiple networks, including both EVM (Base mainnet) and Solana mainnet.

```typescript
{
  "GET /api": {
    accepts: [
      {
        scheme: "exact",
        price: "$0.001",
        network: "eip155:8453",  // Base mainnet
        payTo: "0xYourEvmAddress",
      },
      {
        scheme: "exact",
        price: "$0.001",
        network: "solana:5eykt4UsFv8P8NJdTREpY1vzqKqZKvdp",  // Solana mainnet
        payTo: "YourSolanaAddress",
      },
    ],
    description: "Multi-network endpoint",
  },
}
```

--------------------------------

### x402 Protocol Headers

Source: https://docs.cdp.coinbase.com/x402/support/faq

Documents the key HTTP headers used by the x402 protocol for server-client communication, including PAYMENT-REQUIRED, PAYMENT-SIGNATURE, and PAYMENT-RESPONSE.

```APIDOC
## Protocol & Headers

### What headers does x402 use?

| Header              | Direction       | Purpose                                               |
| ------------------- | --------------- | ----------------------------------------------------- |
| `PAYMENT-REQUIRED`  | Server  Client | Base64-encoded payment requirements (in 402 response) |
| `PAYMENT-SIGNATURE` | Client  Server | Base64-encoded signed payment payload                 |
| `PAYMENT-RESPONSE`  | Server  Client | Settlement confirmation                               |

### Method

N/A (Header explanation)

### Endpoint

N/A (Header explanation)

### Parameters

N/A

### Request Example

N/A

### Response

N/A
```

--------------------------------

### Bazaar Extension Architecture (TypeScript)

Source: https://docs.cdp.coinbase.com/x402/bazaar

Illustrates the structure of the Bazaar extension following the x402 v2 pattern. It defines the 'bazaar' object with 'info' and 'schema' properties for extension configuration.

```typescript
// Extension structure
{
  bazaar: {
    info: {
      input: {
        type: "http",
        method: "GET",
        queryParams: { .     },
      output: {
        type: "json",
        example: { ... }
      }
    },
    schema: {
      // JSON Schema validating the info structure
      "$schema": "https://json-schema.org/draft/2020-12/schema",
      type: "object",
      properties: { ... }
    }
  }
}
```

--------------------------------

### Network Configuration in TypeScript

Source: https://docs.cdp.coinbase.com/x402/miniapps

This code snippet shows how to configure the network identifier in your route settings for mainnet deployment. It uses the CAIP-2 format to specify Base mainnet.

```typescript
network: "eip155:8453", // Base mainnet
```

--------------------------------

### 402 Payment Required Response

Source: https://docs.cdp.coinbase.com/x402/miniapps

Details the structure of the 402 Payment Required response, including the `PAYMENT-REQUIRED` header and its JSON payload.

```APIDOC
## 402 Payment Required Response

### Description
When a request is made to a protected resource without fulfilling the payment requirements, the server responds with a `402 Payment Required` status. The response includes a `PAYMENT-REQUIRED` header containing base64-encoded JSON that specifies the payment details.

### Method
Any (typically GET, POST)

### Endpoint
Any protected endpoint

### Parameters
N/A

### Request Example
N/A

### Response
#### Error Response (402)
- **Status Code**: 402 Payment Required
- **Headers**: `PAYMENT-REQUIRED`: `<base64-encoded JSON>`

#### Response Example (Decoded JSON in `PAYMENT-REQUIRED` header)
```json
{
  "x402Version": 2,
  "error": "Payment required",
  "accepts": [
    {
      "scheme": "exact",
      "network": "eip155:84532",
      "amount": "10000",
      "asset": "0x036CbD53842c5426634e7929541eC2318f3dCF7e",
      "payTo": "0x...",
      "maxTimeoutSeconds": 300,
      "extra": { "name": "USDC", "version": "2" }
    }
  ]
}
```
```

--------------------------------

### x402 Payment Flow

Source: https://docs.cdp.coinbase.com/x402/support/github

Outlines the typical flow of a payment using the x402 protocol, from client request to resource delivery.

```APIDOC
## Typical x402 flow

x402 payments typically adhere to the following flow, but servers have a lot of flexibility. See `advanced` folders in `examples/`.
The following outlines the flow of a payment using the `x402` protocol. Note that steps (1) and (2) are optional if the client already knows the payment details accepted for a resource.

1. `Client` makes an HTTP request to a `resource server`.
2. `Resource server` responds with a `402 Payment Required` status and a `PaymentRequired` b64 object return as a `PAYMENT-REQUIRED` header.
3. `Client` selects one of the `PaymentRequirements` returned by the server response and creates a `PaymentPayload` based on the `scheme` & `network` of the `PaymentRequirements` they have selected.
4. `Client` sends the HTTP request with the `PAYMENT-SIGNATURE` header containing the `PaymentPayload` to the resource server.
5. `Resource server` verifies the `PaymentPayload` is valid either via local verification or by POSTing the `PaymentPayload` and `PaymentRequirements` to the `/verify` endpoint of a `facilitator`.
6. `Facilitator` performs verification of the object based on the `scheme` and `network` of the `PaymentPayload` and returns a `Verification Response`.
7. If the `Verification Response` is valid, the resource server performs the work to fulfill the request. If the `Verification Response` is invalid, the resource server returns a `402 Payment Required` status and a `Payment Required Response` JSON object in the response body.
8. `Resource server` either settles the payment by interacting with a blockchain directly, or by POSTing the `Payment Payload` and `Payment PaymentRequirements` to the `/settle` endpoint of a `facilitator server`.
9. `Facilitator server` submits the payment to the blockchain based on the `scheme` and `network` of the `Payment Payload`.
10. `Facilitator server` waits for the payment to be confirmed on the blockchain.
11. `Facilitator server` returns a `Payment Execution Response` to the resource server.
12. `Resource server` returns a `200 OK` response to the `Client` with the resource they requested as the body of the HTTP response, and a `PAYMENT-RESPONSE` header containing the `Settlement Response` as Base64 encoded JSON if the payment was executed successfully.
```

--------------------------------

### CAIP-2 Network Identifiers for EVM and Solana

Source: https://docs.cdp.coinbase.com/x402/network-support

Demonstrates the CAIP-2 format for identifying EVM and Solana networks. EVM networks use 'eip155:{chainId}', while Solana networks use 'solana:{genesisHash}'. This format ensures standardized network identification across the ecosystem.

```typescript
```typescript  theme={null}
// EVM networks
network: "eip155:8453"      // Base mainnet (chain ID 8453)
network: "eip155:84532"     // Base Sepolia (chain ID 84532)
network: "eip155:1"         // Ethereum mainnet (chain ID 1)

// Solana networks
network: "solana:5eykt4UsFv8P8NJdTREpY1vzqKqZKvdp"  // Solana mainnet
network: "solana:EtWTRABZaYq6iMfeYKouRu166VU2xqa1"  // Solana devnet
```
```

--------------------------------

### Troubleshooting 402 Payment Required

Source: https://docs.cdp.coinbase.com/x402/support/faq

Provides solutions for common issues encountered when receiving a '402 Payment Required' error, even after providing the payment header, such as signature validation and insufficient funds.

```APIDOC
## Troubleshooting

### I keep getting `402 Payment Required`, even after attaching the payment header. Why?

1.  Ensure you're using `PAYMENT-SIGNATURE` header (not the legacy `X-PAYMENT` header).
2.  Signature is invalid (wrong chain ID or payload fields).
3.  Payment amount \< required amount.
4.  Address has insufficient USDC or was flagged by KYT.
    Check the `error` field in the server's JSON response for details.

### Method

N/A (Troubleshooting steps)

### Endpoint

N/A (Troubleshooting steps)

### Parameters

N/A

### Request Example

N/A

### Response

N/A
```

--------------------------------

### Discovery Endpoint API

Source: https://docs.cdp.coinbase.com/x402/bazaar

This section describes the discovery endpoint for facilitators supporting the Bazaar extension. It allows clients to query for available resources based on specified criteria.

```APIDOC
## GET /discovery/resources

### Description
Queries the discovery endpoint to find available resources exposed by a facilitator that supports the Bazaar extension. Allows filtering by resource type and pagination.

### Method
GET

### Endpoint
`{facilitator_url}/discovery/resources`

### Query Parameters
#### Query Parameters
- **type** (string) - Optional - Filter by protocol type (e.g., "http")
- **limit** (number) - Optional - Number of resources to return (default: 20)
- **offset** (number) - Optional - Offset for pagination (default: 0)

### Response
#### Success Response (200)
- **x402Version** (number) - The x402 protocol version supported by the facilitator.
- **items** (array) - A list of discovered resources. Each item contains:
  - **resource** (string) - The URL or identifier of the discovered resource.
  - **type** (string) - The protocol type of the resource (e.g., "http").
  - **x402Version** (number) - The x402 version supported by this specific resource.
  - **accepts** (array) - A list of payment methods accepted by the resource.
  - **lastUpdated** (string) - The timestamp when the resource was last updated.
  - **metadata** (object) - Optional - Additional metadata about the resource.
- **pagination** (object) - Information about the pagination of the results.
  - **limit** (number) - The limit used for the current request.
  - **offset** (number) - The offset used for the current request.
  - **total** (number) - The total number of available resources.

#### Response Example
{
  "x402Version": 1,
  "items": [
    {
      "resource": "https://example.com/service/1",
      "type": "http",
      "x402Version": 1,
      "accepts": [{"method": "evm.exact"}],
      "lastUpdated": "2023-10-27T10:00:00Z",
      "metadata": {"name": "Example Service"}
    }
  ],
  "pagination": {
    "limit": 20,
    "offset": 0,
    "total": 50
  }
}
```

--------------------------------

### CDP Facilitator Discovery Endpoint

Source: https://docs.cdp.coinbase.com/x402/bazaar

This endpoint allows clients to discover available resources managed by the CDP facilitator. It returns a list of resources, each with details about its type, supported payment methods, and metadata.

```APIDOC
## GET /platform/v2/x402/discovery/resources

### Description
Retrieves a list of discoverable resources from the CDP facilitator.

### Method
GET

### Endpoint
/platform/v2/x402/discovery/resources

### Query Parameters
- **limit** (number) - Optional - The maximum number of results to return per page. Default is 100.
- **offset** (number) - Optional - The number of results to skip for pagination. Default is 0.

### Response
#### Success Response (200)
- **x402Version** (number) - The version of the x402 protocol.
- **items** (array) - An array of discovered resource objects.
  - **resource** (string) - The resource URL being monetized.
  - **type** (string) - Resource type (e.g., "http").
  - **x402Version** (number) - Protocol version supported by the resource.
  - **accepts** (array) - Array of PaymentRequirements specifying accepted payment methods.
  - **lastUpdated** (string) - ISO 8601 timestamp of when the resource was last updated.
  - **metadata** (object) - Additional metadata (description, schemas, etc.).
- **pagination** (object) - Pagination details.
  - **limit** (number) - The limit applied to the current page.
  - **offset** (number) - The offset applied to the current page.
  - **total** (number) - The total number of available resources.

#### Response Example
```json
{
  "x402Version": 2,
  "items": [
    {
      "resource": "https://api.example.com/weather",
      "type": "http",
      "x402Version": 1,
      "accepts": [
        {
          "scheme": "exact",
          "network": "eip155:84532",
          "amount": "1000",
          "asset": "0x036CbD53842c5426634e7929541eC2318f3dCF7e",
          "payTo": "0x209693Bc6afc0C5328bA36FaF03C514EF312287C"
        }
      ],
      "lastUpdated": "2024-01-15T12:30:00.000Z",
      "metadata": {
        "description": "Weather data API",
        "input": { ... },
        "output": { ... }
      }
    }
  ],
  "pagination": {
    "limit": 20,
    "offset": 0,
    "total": 42
  }
}
```
```

--------------------------------

### AI Agent Payment Flow

Source: https://docs.cdp.coinbase.com/x402/support/faq

Details the process by which AI agents interact with the x402 protocol to make payments, including request initiation, parsing payment requirements, and signing payloads.

```APIDOC
## Usage by AI Agents

### How does an agent know what to pay?

Agents follow the same flow as humans:

1.  Make a request.
2.  Parse the `PAYMENT-REQUIRED` header (base64-encoded payment requirements).
3.  Choose a suitable requirement from the `accepts` array and sign a payload via the x402 client SDKs.
4.  Retry with `PAYMENT-SIGNATURE` header.

### Do agents need wallets?

Yes. Programmatic wallets (e.g., **CDP Server Wallet**, `viem`, `ethers-v6` HD wallets) let agents sign payment payloads without exposing seed phrases.

### Method

N/A (Process explanation)

### Endpoint

N/A (Process explanation)

### Parameters

N/A

### Request Example

N/A

### Response

N/A
```

--------------------------------

### Successful Payment Response JSON

Source: https://docs.cdp.coinbase.com/x402/miniapps

This JSON object represents a successful response after a protected action has been completed following a payment. It includes a success status, a message, a timestamp, and data specific to the action, such as a secret message and access time.

```json
{
  "success": true,
  "message": "Protected action completed successfully",
  "timestamp": "2024-01-01T00:00:00Z",
  "data": {
    "secretMessage": "This content was paid for with x402!",
    "accessedAt": 1704067200000
  }
}
```

--------------------------------

### 402 Payment Required Response Format

Source: https://docs.cdp.coinbase.com/x402/miniapps

Illustrates the structure of a '402 Payment Required' HTTP response, including the custom `PAYMENT-REQUIRED` header. The header contains base64-encoded JSON detailing the payment requirements, such as accepted schemes, network, amount, and asset.

```json
{
  "x402Version": 2,
  "error": "Payment required",
  "accepts": [
    {
      "scheme": "exact",
      "network": "eip155:84532",
      "amount": "10000",
      "asset": "0x036CbD53842c5426634e7929541eC2318f3dCF7e",
      "payTo": "0x...",
      "maxTimeoutSeconds": 300,
      "extra": { "name": "USDC", "version": "2" }
    }
  ]
}

```

--------------------------------

### Solana Networks: Common Token Addresses

Source: https://docs.cdp.coinbase.com/x402/network-support

Common token addresses for SPL and Token2022 tokens on Solana mainnet. A faucet is available for Devnet.

```text
USDC  EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v | (faucet available)
```

--------------------------------

### EVM Networks: EIP-3009 Token Addresses

Source: https://docs.cdp.coinbase.com/x402/network-support

Common token addresses for EIP-3009 compliant tokens on EVM networks like Base and Base Sepolia. These addresses are used with the CDP facilitator.

```text
USDC  0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913 | 0x036CbD53842c5426634e7929541eC2318f3dCF7e
```

--------------------------------

### CDP Coinbase x402 Response Schema

Source: https://docs.cdp.coinbase.com/x402/bazaar

This JSON structure defines the schema for responses from the CDP Coinbase x402 discovery endpoint. It includes details about resources, payment requirements, and pagination.

```json
{
  "x402Version": 2,
  "items": [
    {
      "resource": "https://api.example.com/weather",
      "type": "http",
      "x402Version": 1,
      "accepts": [
        {
          "scheme": "exact",
          "network": "eip155:84532",
          "amount": "1000",
          "asset": "0x036CbD53842c5426634e7929541eC2318f3dCF7e",
          "payTo": "0x209693Bc6afc0C5328bA36FaF03C514EF312287C"
        }
      ],
      "lastUpdated": "2024-01-15T12:30:00.000Z",
      "metadata": {
        "description": "Weather data API",
        "input": { ... },
        "output": { ... }
      }
    }
  ],
  "pagination": {
    "limit": 20,
    "offset": 0,
    "total": 42
  }
}
```

=== COMPLETE CONTENT === This response contains all available snippets from this library. No additional content exists. Do not make further requests.

