%%{init: {'theme': 'dark', 'sequence': {'mirrorActors': false, 'actorMargin': 40, 'messageMargin': 35}}}%%

sequenceDiagram
    autonumber

    participant User as üë§ Treasurer
    participant FE as üì± Frontend
    participant ENS as üåê ENS
    participant TAgent as ü§ñ treasury-agent
    participant Strategy as üéØ strategy-agent
    participant Executor as ‚öôÔ∏è AgentExecutor
    participant Roles as üîê RolesModifier
    participant Safe as üè¶ Safe
    participant PM as ü¶Ñ PoolManager
    participant Hook as üìù ReceiptHook
    participant Rep as ‚≠ê ReputationRegistry

    rect rgb(40, 40, 60)
        Note over User,ENS: 1Ô∏è‚É£ DISCOVERY & POLICY SETUP
        User->>FE: Select treasury agent
        FE->>ENS: Resolve treasury.brand.eth
        ENS-->>FE: agent:mode=safe-roles<br/>agent:safe=0x...<br/>agent:rolesModifier=0x...
        FE->>TAgent: GET /a2a/agent-card
        TAgent-->>FE: capabilities, policy templates
        FE-->>User: Display policy options
        User->>FE: Choose: 70/20/10 split<br/>max 30bps slippage, $50k/day
    end

    rect rgb(60, 40, 40)
        Note over User,Roles: 2Ô∏è‚É£ DAO AUTHORIZATION (Mode B)
        User->>FE: Submit policy for DAO vote
        Note over FE: DAO approves policy
        FE->>TAgent: Configure Roles permissions
        TAgent->>Roles: setRole(agentExecutor, permissions)
        Note right of Roles: Allowed:<br/>‚Ä¢ target: UniversalRouter<br/>‚Ä¢ tokens: USDC,USDT,DAI<br/>‚Ä¢ maxDaily: $50k<br/>‚Ä¢ slippage: 30bps
    end

    rect rgb(40, 50, 40)
        Note over TAgent,Strategy: 3Ô∏è‚É£ TRIGGER & QUOTE GENERATION
        Note over TAgent: ‚è∞ Trigger fires<br/>(drift > 5% threshold)
        TAgent->>TAgent: computeRebalance()<br/>Current: 65/25/10<br/>Target: 70/20/10
        TAgent->>Strategy: Request quote (A2A)
        Strategy->>Strategy: Generate optimal route<br/>USDT ‚Üí USDC via v4
        Strategy-->>TAgent: Quote<br/>quoteId: 0xabc...<br/>expectedSlippage: 15bps
    end

    rect rgb(40, 60, 40)
        Note over Executor,PM: 4Ô∏è‚É£ EXECUTION (Safe + Roles Flow)
        TAgent->>Executor: Execute rebalance

        Note over Executor,Safe: AgentExecutor ‚Üí Roles ‚Üí Safe
        Executor->>Roles: execTransactionWithRole(<br/>  target: UniversalRouter,<br/>  data: swapCalldata,<br/>  roleKey: 0x...<br/>)
        Roles->>Roles: ‚úÖ Check permissions
        Roles->>Safe: execTransactionFromModule(<br/>  to: UniversalRouter,<br/>  data: swapCalldata<br/>)
        Safe->>PM: Execute swap

        Note over PM,Hook: v4 Swap with Receipt Hook
        PM->>PM: swap(poolKey, params, hookData)
        Note right of PM: hookData = abi.encode(<br/>  strategyId,<br/>  quoteId: 0xabc...,<br/>  maxSlippage: 30bps<br/>)
        PM->>Hook: afterSwap(delta, hookData)
    end

    rect rgb(40, 40, 80)
        Note over Hook,Rep: 5Ô∏è‚É£ RECEIPT & REPUTATION
        Hook->>Hook: Calculate actualSlippage
        Hook->>Hook: emit ExecutionReceipt(<br/>  strategyId,<br/>  quoteId: 0xabc...,<br/>  amount0: -5000 USDT,<br/>  amount1: +4998 USDC,<br/>  actualSlippage: 12bps,<br/>  policyCompliant: true ‚úÖ<br/>)

        Hook-->>FE: Receipt event indexed

        Note over Hook,Rep: Feed Reputation Registry
        FE->>Rep: giveFeedback(<br/>  agentId,<br/>  value: 100,<br/>  tag: "execution"<br/>)

        FE-->>User: "Rebalanced to 70/20/10 ‚úÖ<br/>Slippage: 12bps (under 30bps cap)"
    end

    rect rgb(50, 50, 40)
        Note over Hook,Rep: 6Ô∏è‚É£ STRATEGY SCORING
        Note over Hook: On-chain stats updated:<br/>‚Ä¢ totalSwaps++<br/>‚Ä¢ avgSlippage recalculated<br/>‚Ä¢ complianceRate updated
        Hook-->>Strategy: Performance tracked
    end
