%%{init: {'theme': 'dark', 'flowchart': {'nodeSpacing': 40, 'rankSpacing': 60}}}%%

flowchart TB
    subgraph CLIENT["üì± CLIENT APPLICATION"]
        APP["Wallet / dApp / Integrator"]
    end

    subgraph RESOLUTION["üåê ENS RESOLUTION"]
        direction TB
        ENS_NAME["ENS Name<br/><code>treasury.brand.eth</code>"]

        subgraph RECORDS["Agent Text Records"]
            R1["<b>agent:type</b> = treasury"]
            R2["<b>agent:version</b> = 0.1.0"]
            R3["<b>agent:chainId</b> = 11155111"]
            R4["<b>agent:entrypoint</b> = 0x..."]
            R5["<b>agent:mode</b><br/>intent-only | safe-roles"]
            R6["<b>agent:erc8004</b><br/>eip155:11155111:0xReg:42"]
        end

        subgraph MODE_RECORDS["Mode-Specific Records"]
            R_SAFE["<b>agent:safe</b> = 0x..."]
            R_ROLES["<b>agent:rolesModifier</b> = 0x9646f..."]
            R_ROLE_KEY["<b>agent:roleKey</b> = 0x..."]
        end

        subgraph PROTOCOL_RECORDS["Protocol Endpoints"]
            R_A2A["<b>agent:a2a</b> = https://..."]
            R_MCP["<b>agent:mcp</b> = https://..."]
            R_X402["<b>agent:x402</b> = https://..."]
        end

        ENS_NAME --> RECORDS
        RECORDS --> MODE_RECORDS
        RECORDS --> PROTOCOL_RECORDS
    end

    subgraph IDENTITY["ü™™ ERC-8004 VERIFICATION"]
        ID_REG["Identity Registry"]
        AGENT_ID["agentId #42"]
        AGENT_URI["agentURI ‚Üí Agent Record JSON"]
        AGENT_WALLET["agentWallet (verified)"]

        ID_REG --> AGENT_ID
        AGENT_ID --> AGENT_URI
        AGENT_ID --> AGENT_WALLET
    end

    subgraph A2A_DISCOVERY["ü§ñ A2A DISCOVERY"]
        A2A_CARD["GET /.well-known/agent-card.json"]
        A2A_CAPS["Capabilities:<br/>‚Ä¢ check_policy<br/>‚Ä¢ get_rebalance_plan<br/>‚Ä¢ execute_swap"]

        A2A_CARD --> A2A_CAPS
    end

    subgraph X402_CHECK["üí≥ x402 PAYMENT CHECK (Optional)"]
        X402_GATE["Strategy services may require payment"]
        X402_PRICE["GET /quote ‚Üí 402 Payment Required"]
        X402_PAY["Pay via USDC (Base Sepolia)"]

        X402_GATE --> X402_PRICE
        X402_PRICE --> X402_PAY
    end

    subgraph MODE_BRANCH["üîÄ MODE BRANCHING"]
        CHECK_MODE{{"Check agent:mode"}}

        subgraph INTENT_PATH["Mode A: Intent-First"]
            I1["Display policy to user"]
            I2["User signs EIP-712 intent"]
            I3["Submit to IntentRouter"]
        end

        subgraph SAFE_PATH["Mode B: Safe+Roles"]
            S1["Verify Safe address"]
            S2["Check Roles permissions"]
            S3["AgentExecutor submits via Roles"]
        end

        CHECK_MODE -->|"intent-only"| INTENT_PATH
        CHECK_MODE -->|"safe-roles"| SAFE_PATH
    end

    subgraph EXECUTE["‚öôÔ∏è EXECUTION"]
        SWAP["PoolManager.swap()<br/><small>0xE03A1074...</small>"]
        HOOK["ReceiptHook.afterSwap()"]

        SWAP --> HOOK
    end

    subgraph VERIFY["üìù RECEIPT VERIFICATION"]
        RECEIPT["ExecutionReceipt Event"]
        VERIFY_CHAIN["Verify on-chain:<br/>‚Ä¢ Check event logs<br/>‚Ä¢ Validate strategyId<br/>‚Ä¢ Confirm policyCompliant"]
        REP_CHECK["Query Reputation Registry<br/>for strategy score"]

        RECEIPT --> VERIFY_CHAIN
        VERIFY_CHAIN --> REP_CHECK
    end

    %% Main Flow
    APP -->|"1. Resolve ENS"| ENS_NAME
    R6 -->|"2. Verify identity"| ID_REG
    R_A2A -->|"3. Discover capabilities"| A2A_CARD
    R_X402 -.->|"4. Check payment (if strategy)"| X402_GATE

    A2A_CAPS -->|"5. Branch by mode"| CHECK_MODE

    INTENT_PATH -->|"6a. Execute"| SWAP
    SAFE_PATH -->|"6b. Execute"| SWAP

    HOOK -->|"7. Emit"| RECEIPT
    REP_CHECK -->|"8. Return to client"| APP

    %% Styling
    classDef client fill:#7c3aed,stroke:#5b21b6,color:#fff
    classDef ens fill:#3b82f6,stroke:#2563eb,color:#fff
    classDef identity fill:#10b981,stroke:#059669,color:#fff
    classDef a2a fill:#6366f1,stroke:#4f46e5,color:#fff
    classDef x402 fill:#f59e0b,stroke:#d97706,color:#fff
    classDef branch fill:#8b5cf6,stroke:#7c3aed,color:#fff
    classDef exec fill:#ff007a,stroke:#cc0062,color:#fff
    classDef verify fill:#06b6d4,stroke:#0891b2,color:#fff

    class APP client
    class ENS_NAME,R1,R2,R3,R4,R5,R6,R_SAFE,R_ROLES,R_ROLE_KEY,R_A2A,R_MCP,R_X402 ens
    class ID_REG,AGENT_ID,AGENT_URI,AGENT_WALLET identity
    class A2A_CARD,A2A_CAPS a2a
    class X402_GATE,X402_PRICE,X402_PAY x402
    class CHECK_MODE,I1,I2,I3,S1,S2,S3 branch
    class SWAP,HOOK exec
    class RECEIPT,VERIFY_CHAIN,REP_CHECK verify
